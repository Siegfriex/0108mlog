# 백엔드 위험요인 해결 플랜 (현재 코드베이스용)

**기준 코드베이스**: C:\INEESm

**검증 완료**: 2026-01-17 (최종 업데이트)

**위험요인**: 7개 (Critical 1, High 3, Medium 3)

**즉시 조치**: 1개 (Critical 타임아웃 통일)

**프론트엔드 연계**: FE-H13 (CoachPersona 타입) 완료 후 백엔드 타입 동기화 필요

**총 기간**: 0.5일 (4시간)

---

## 전제 조건

✅ **검증 완료 항목**:

- generateDayModeResponse: 90초 (너무 김)
- 5개 Functions: 60초 (너무 김)
- 2개 Functions: 30초 (OK)
- callGeminiAPI에 retry() 사용 (재시도 1회)
- sanitizeUserInput 10000자 제한 (프론트와 불일치)

**프론트엔드 선행 조건**:

- [ ] 프론트엔드 P0 5개 완료
- [ ] 입력 길이 검증 maxLength=10000 적용 완료

---

## Day 0: 사전 준비 (30분)

### Task 0.1: Git 백업

```bash
cd C:\INEESm

# Functions 디렉토리 백업
git add functions/
git status
git commit -m "chore: backup before backend P0 fixes"
git tag v5.0-be-p0-start
git push origin v5.0-be-p0-start
```

---

### Task 0.2: Functions 의존성 점검

```bash
cd functions

# 의존성 확인
npm outdated
npm audit

# 보안 취약점 수정
npm audit fix

# 빌드 테스트
npm run build
```

---

### Task 0.3: 현재 타임아웃 확인

```bash
# 타임아웃 설정 확인
rg "timeoutSeconds" functions/src/api/gemini.ts

# 예상 출력:
# 20:    timeoutSeconds: 90,     ← 수정 필요
# 97:    timeoutSeconds: 60,     ← 수정 필요
# 168:   timeoutSeconds: 60,     ← 수정 필요
# 226:   timeoutSeconds: 60,     ← 수정 필요
# 347:   timeoutSeconds: 60,     ← 수정 필요
# 420:   timeoutSeconds: 30,     ← OK
# 529:   timeoutSeconds: 30,     ← OK
```

---

## Day 1: Critical 타임아웃 통일 (3시간)

### Task 1.1: Functions 타임아웃 30초로 단축 (30분)

**파일**: [`functions/src/api/gemini.ts`](functions/src/api/gemini.ts)

**수정 위치 및 내용**:

#### 1. generateDayModeResponse (라인 17-24)

```typescript
export const generateDayModeResponse = onCall(
  {
    region: "asia-northeast3",
    timeoutSeconds: 30, // 90 → 30 ✏️
    memory: "512MiB",
    maxInstances: 10,
  },
  async (request) => {
    // 기존 코드 유지
```

#### 2. generateNightModeLetter (라인 94-101)

```typescript
export const generateNightModeLetter = onCall(
  {
    region: "asia-northeast3",
    timeoutSeconds: 30, // 60 → 30 ✏️
    memory: "512MiB",
    maxInstances: 5,
  },
  async (request) => {
    // 기존 코드 유지
```

#### 3. generateMonthlyNarrative (라인 165-172)

```typescript
export const generateMonthlyNarrative = onCall(
  {
    region: "asia-northeast3",
    timeoutSeconds: 30, // 60 → 30 ✏️
    memory: "512MiB",
    maxInstances: 3,
  },
  async (request) => {
    // 기존 코드 유지
```

#### 4. generateHealingContent (라인 223-230)

```typescript
export const generateHealingContent = onCall(
  {
    region: "asia-northeast3",
    timeoutSeconds: 30, // 60 → 30 ✏️
    memory: "512MiB", // 1GiB는 일단 유지 (Google Search 필요)
    maxInstances: 5,
  },
  async (request) => {
    // 기존 코드 유지
```

#### 5. generateChatbotResponse (라인 344-351)

```typescript
export const generateChatbotResponse = onCall(
  {
    region: "asia-northeast3",
    timeoutSeconds: 30, // 60 → 30 ✏️
    memory: "512MiB",
    maxInstances: 10,
  },
  async (request) => {
    // 기존 코드 유지
```

#### 6-7. generateMicroAction, generateTimelineAnalysis

**유지**: 이미 30초이므로 수정 불필요

**검증**:

```bash
rg "timeoutSeconds" functions/src/api/gemini.ts

# 모든 Functions가 30초 이하여야 함
```

**커밋**:

```bash
git add functions/src/api/gemini.ts
git commit -m "fix(functions): reduce timeout to 30 seconds (BE-C1)"
```

---

### Task 1.2: 빌드 및 배포 (1시간)

**빌드**:

```bash
cd functions
npm run build

# 빌드 에러 확인
# TypeScript 에러 0개여야 함
```

**배포 전 확인**:

```bash
# Firebase 프로젝트 확인
firebase use

# 예상 출력: Active Project: iness-mlog (INEESm)

# Functions 목록 확인
firebase functions:list
```

**배포**:

```bash
# 전체 Functions 배포
firebase deploy --only functions

# 또는 개별 배포 (테스트용)
firebase deploy --only functions:generateDayModeResponse
```

**배포 시간**: 약 5-10분

---

### Task 1.3: 배포 검증 (1.5시간)

#### 1. 즉시 검증 (배포 직후 5분)

```bash
# Functions 상태 확인
firebase functions:list

# 로그 모니터링
firebase functions:log --only generateDayModeResponse --limit 50
```

**확인 사항**:

- [ ] 모든 Functions 배포 완료 (ACTIVE 상태)
- [ ] 에러 없음

---

#### 2. 타임아웃 발생 확인 (1시간 모니터링)

```bash
# 타임아웃 발생 확인 (30초 초과 시 타임아웃)
gcloud logging read \
  "resource.type=cloud_function AND textPayload:timeout" \
  --limit 100 \
  --format json

# 예상: 타임아웃 0건
```
```bash
# 평균 응답 시간 확인
gcloud logging read \
  "resource.type=cloud_function AND jsonPayload.callDuration" \
  --limit 1000 \
  --format json | \
  jq -r '.[] | .jsonPayload.callDuration' | \
  awk '{sum+=$1; count++} END {
    print "평균:", sum/count "ms";
    print "예상 필요:", sum/count < 25000 ? "OK" : "타임아웃 위험"
  }'

# 예상: 평균 < 25초 (여유 5초)
```

---

#### 3. 실제 호출 테스트 (30분)

**프론트엔드에서 테스트**:

```bash
# 프론트엔드 로컬 실행
cd C:\INEESm
npm run dev
```

**테스트 케이스**:

- [ ] 1. DayMode 채팅 입력 → 응답 받기 (10초 이내)
- [ ] 2. NightMode 일기 작성 → 편지 받기 (15초 이내)
- [ ] 3. 콘텐츠 큐레이션 → 시/명상 받기 (15초 이내)
- [ ] 4. AI 챗봇 질문 → 응답 받기 (10초 이내)
- [ ] 5. 마이크로 액션 제안 받기 (10초 이내)

**에러 발생 시**:

```bash
# 에러 로그 확인
firebase functions:log --only <function_name>

# 타임아웃 발생 확인
gcloud logging read \
  "resource.type=cloud_function AND jsonPayload.functionName=generateDayModeResponse AND severity>=ERROR" \
  --limit 50
```

---

## Day 2: High 위험요인 (선택사항, 1시간)

### Task 2.1: Gemini API 재시도 제거 (선택)

**파일**: [`functions/src/services/gemini.ts`](functions/src/services/gemini.ts)

**현재 상태** (라인 154):

```typescript
return await retry(
  async () => {
    // Gemini API 호출
  },
  {
    retries: 1,
    // ...
  }
);
```

**수정 후** (retry 제거):

```typescript
// retry import 제거
// import retry from 'async-retry'; ← 삭제

// 직접 호출
try {
  const client = await initializeGeminiClient();
  
  const requestOptions = {
    model,
    contents: prompt,
    ...(options?.tools && { config: { tools: options.tools } }),
  };
  
  const response = await client.models.generateContent(requestOptions);
  
  logPerformance(geminiServiceContext, "gemini_api_call", Date.now() - apiStartTime, {
    model,
    success: true,
  });
  
  return response.text || "";
} catch (error) {
  const errorType = classifyGeminiError(error as Error);
  logError(geminiServiceContext, error, {
    errorType,
    model,
    totalDurationMs: Date.now() - apiStartTime,
  });
  throw error;
}
```

**주의**: 재시도 제거 후 성공률 감소 위험

- 배포 후 3일간 성공률 모니터링 필수
- 성공률 < 95% 시 롤백

---

## 모니터링 및 알림

### Cloud Monitoring 대시보드

**핵심 메트릭**:

1. Functions 실행 시간 (P50, P95, P99)
2. 타임아웃 발생 횟수
3. 에러율 (4xx, 5xx)
4. Gemini API 호출 횟수
5. 비용 (실행 시간 × 호출 횟수)

**알림 설정** (선택사항):

```bash
# Slack, 이메일 등으로 알림
# 타임아웃 발생 시
# 에러율 > 5% 시
# P95 > 25초 시
```

---

### 비용 절감 예상

**타임아웃 단축 효과**:

- generateDayModeResponse: 90초 → 30초 (**67% 절감**)
- 5개 Functions: 60초 → 30초 (**50% 절감**)

**월간 비용 예상** (사용자 100명 기준):

- **Before**: $120-180
- **After**: $60-90
- **절감**: $60-90/월 (**50% 절감**)

---

## 롤백 계획

### 타임아웃 너무 짧을 경우

**증상**:

- 타임아웃 에러 급증 (> 5%)
- 사용자 불만 증가

**롤백**:

```bash
# 이전 버전으로 롤백
git revert <commit_hash>
cd functions
npm run build
firebase deploy --only functions
```

**또는 타임아웃만 45초로 증가**:

```typescript
timeoutSeconds: 45, // 30 → 45 (절충안)
```

---

## 완료 체크리스트

### Critical (P0) - 1개

- [ ] BE-C1: 타임아웃 30초로 단축
  - [ ] 코드 수정 (7개 Functions 중 5개)
  - [ ] 빌드 성공
  - [ ] 배포 완료
  - [ ] 타임아웃 0건 (1시간 모니터링)
  - [ ] 실제 호출 테스트 5개 통과

### High (P1) - 선택사항

- [ ] BE-H1: Gemini API 재시도 제거
  - [ ] 코드 수정
  - [ ] 배포 완료
  - [ ] 성공률 모니터링 (3일간)
  - [ ] 성공률 > 95% 확인

### 프론트엔드 연계 확인

- [ ] FE-H13: CoachPersona 타입 확장 완료 확인
  - [ ] types.ts에 CoachPersonaExtended 추가됨
  - [ ] 백엔드 타입 정의도 동기화 필요 시 업데이트

---

## 다음 단계

1. **프론트엔드 P0 + P1 완료 확인** (FE-H13 포함)
2. **백엔드 P0 배포**
3. **통합 테스트** (프론트 + 백엔드)
4. **프로덕션 배포**
5. **24시간 모니터링**
6. **P1 위험요인 해결** (별도 플랜)

---

**총 예상 시간**: 4시간 (사전 준비 30분 + Critical 3시간 + High 30분)

**권장 일정**: 0.5일

**배포 순서**: 프론트엔드 먼저 (P0 + P1) → 검증 → 백엔드 (P0)

**주의**: 프론트엔드 타입 확장 후 백엔드 타입 동기화 필요 여부 확인