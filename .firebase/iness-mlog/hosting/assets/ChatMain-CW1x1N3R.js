import{j as t,m as x,A as P}from"./framer-motion-BL4N7xFA.js";import{r as o,d as he}from"./react-vendor-CHpw1G1i.js";import{B as _,g as Te,E as O,a as Ae,b as ge,s as ve,c as fe,d as ke,e as Ie,u as _e,f as Re,G as te,h as Me,i as De,j as Oe,k as ze,l as $e,m as Le,P as Fe,n as ae,o as Pe,p as Ge,q as He,r as Ue}from"./index-AFX2_y7y.js";import{t as Ye,X as ie,r as Ve,n as We,P as Be,M as be,C as Ke,g as J,k as Xe,u as Je,v as qe,w as Qe,x as Ze,m as je,q as et,h as tt,S as Ne,c as we,F as Se,d as Ee,e as Ce,y as it,A as st,z as re,D as nt}from"./lucide-react-J6DJLIhr.js";import{V as at}from"./VoicePlayer-B9Gf_T1N.js";import"./firebase-BBl07Gss.js";const rt=({intensity:e="medium"})=>{const s=e==="low"?20:e==="high"?60:40;return t.jsxs("div",{className:"absolute inset-0 pointer-events-none overflow-hidden z-base",children:[Array.from({length:s}).map((a,r)=>{const l=Math.random()*3+1,n=Math.random()*100,c=Math.random()*100,d=Math.random()*2,i=Math.random()*3+2;return t.jsx(x.div,{className:"absolute rounded-full bg-white",style:{width:`${l}px`,height:`${l}px`,left:`${n}%`,top:`${c}%`},animate:{opacity:[.3,1,.3],scale:[1,1.2,1]},transition:{duration:i,repeat:1/0,delay:d,ease:"easeInOut"}},`star-${r}`)}),t.jsx(x.div,{className:"absolute rounded-full blur-xl",style:{width:"200px",height:"200px",background:"radial-gradient(circle, rgba(255,255,255,0.3), transparent)",top:"10%",right:"15%"},animate:{opacity:[.4,.6,.4],scale:[1,1.05,1]},transition:{duration:4,repeat:1/0,ease:"easeInOut"}}),t.jsx(x.div,{className:"absolute w-full h-full",style:{background:"linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.15) 50%, transparent 100%)",top:0,left:0},animate:{opacity:[.3,.5,.3]},transition:{duration:6,repeat:1/0,ease:"easeInOut"}})]})},ot=()=>t.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[t.jsxs(x.div,{className:"relative w-8 h-8",animate:{rotate:360},transition:{duration:2,repeat:1/0,ease:"linear"},children:[t.jsx(x.div,{className:"absolute inset-0 rounded-full border-2 border-brand-primary/30",animate:{scale:[1,1.2,1],opacity:[.5,.8,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),t.jsx(x.div,{className:"absolute top-1/2 left-1/2 w-2 h-2 -translate-x-1/2 -translate-y-1/2 bg-brand-primary rounded-full",animate:{scale:[1,1.5,1],opacity:[1,.7,1]},transition:{duration:1,repeat:1/0,ease:"easeInOut"}})]}),t.jsx("div",{className:"flex gap-1",children:[0,1,2].map(e=>t.jsx(x.div,{className:"w-2 h-2 bg-brand-primary rounded-full",animate:{y:[0,-8,0],opacity:[.5,1,.5],scale:[1,1.2,1]},transition:{duration:.8,repeat:1/0,delay:e*.2,ease:"easeInOut"}},e))}),t.jsx(x.span,{className:"text-xs text-slate-500 font-medium",animate:{opacity:[.5,1,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"생각 중..."})]}),lt=(e,s)=>{const a=s===0||s===6,r=[];return e>=6&&e<9?r.push("아침","출근 전"):e>=9&&e<12?(r.push("오전","업무"),a||r.push("회의")):e>=12&&e<14?r.push("점심","식사"):e>=14&&e<18?r.push("오후","업무"):e>=18&&e<22?r.push("저녁","퇴근 후"):r.push("밤","휴식"),s===1&&r.push("월요일"),a&&r.push("주말"),r.slice(0,3)},ct=e=>{if(!e)return[];const s=[];return e.placeType==="work"?s.push("회사","업무","동료"):e.placeType==="home"?s.push("집","홈","가족"):s.push("외출","이동"),s.slice(0,3)},dt=["출근","퇴근","회의","업무","점심","저녁","아침","밤","주말","휴식","운동","독서","가족","친구","혼자","스트레스","기쁨","평온","불안","슬픔","분노","피곤","에너지","집중"],mt=({onTagsChange:e,initialTags:s=[],locationPermission:a="default"})=>{const[r,l]=o.useState(s),[n,c]=o.useState([]),[d,i]=o.useState(null),[g,S]=o.useState(!1),[h,A]=o.useState("");o.useEffect(()=>{(async()=>{const E=new Date,p=E.getHours(),N=E.getDay(),M=lt(p,N);c(M),a==="granted"&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(C=>{const R={latitude:C.coords.latitude,longitude:C.coords.longitude,placeType:p>=9&&p<18&&N>=1&&N<=5?"work":"other"};i(R);const k=ct(R);c(u=>[...u,...k].slice(0,3))},C=>{console.warn("위치 감지 실패:",C)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:6e4})})()},[a]);const f=m=>{if(r.includes(m)){const E=r.filter(p=>p!==m);l(E),e(E)}else if(r.length<3){const E=[...r,m];l(E),e(E)}},b=()=>{if(h.trim()&&r.length<3&&!r.includes(h.trim())){const m=[...r,h.trim()];l(m),e(m),A(""),S(!1)}},j=m=>{const E=r.filter(p=>p!==m);l(E),e(E)};return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-slate-900 text-sm mb-1",children:"상황 태그"}),t.jsx("p",{className:"text-xs text-slate-500",children:"오늘은 어떤 상황이었나요? (선택사항, 최대 3개)"})]}),r.length>0&&t.jsxs("span",{className:"text-xs font-bold text-brand-primary",children:[r.length,"/3"]})]}),r.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:r.map(m=>t.jsxs(x.div,{initial:{scale:0},animate:{scale:1},className:"flex items-center gap-2 px-3 py-1.5 bg-brand-primary text-white rounded-full text-sm font-medium",children:[t.jsx(Ye,{size:14}),t.jsx("span",{children:m}),t.jsx("button",{onClick:()=>j(m),className:"hover:bg-white/20 rounded-full p-0.5 transition-colors","aria-label":`${m} 태그 제거`,children:t.jsx(ie,{size:14})})]},m))}),n.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(Ve,{size:14,className:"text-slate-400"}),t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"추천 태그"}),d&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-slate-300",children:"•"}),t.jsx(We,{size:14,className:"text-slate-400"}),t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"위치 기반"})]})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:n.filter(m=>!r.includes(m)).map(m=>t.jsx(x.button,{onClick:()=>f(m),whileHover:{scale:1.05},whileTap:{scale:.95},disabled:r.length>=3,className:`
                    px-3 py-1.5 rounded-full text-sm font-medium
                    transition-all duration-300
                    ${r.length>=3?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-white/80 border border-white/60 text-slate-700 hover:bg-brand-light hover:border-brand-primary/30"}
                  `,children:m},m))})]}),r.length<3&&t.jsx("div",{children:g?t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:h,onChange:m=>A(m.target.value),onKeyPress:m=>m.key==="Enter"&&b(),placeholder:"태그 입력 (최대 10자)",maxLength:10,className:"flex-1 px-3 py-2 rounded-lg bg-white/80 border border-white/60 focus:outline-none focus:ring-2 focus:ring-brand-primary/50 text-sm"}),t.jsx(_,{onClick:b,variant:"primary",disabled:!h.trim(),className:"!px-4 !py-2",children:"추가"}),t.jsx(_,{onClick:()=>{S(!1),A("")},variant:"ghost",className:"!px-4 !py-2",children:"취소"})]}):t.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-2 px-3 py-1.5 text-sm text-slate-500 hover:text-brand-primary transition-colors",children:[t.jsx(Be,{size:14}),t.jsx("span",{children:"직접 입력하기"})]})}),r.length<3&&!g&&t.jsxs("details",{className:"text-xs",children:[t.jsx("summary",{className:"cursor-pointer text-slate-400 hover:text-slate-600 mb-2",children:"더 많은 태그 보기"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:dt.filter(m=>!r.includes(m)&&!n.includes(m)).slice(0,12).map(m=>t.jsx("button",{onClick:()=>f(m),disabled:r.length>=3,className:`
                    px-2 py-1 rounded-md text-xs
                    transition-all duration-300
                    ${r.length>=3?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-slate-50 text-slate-600 hover:bg-brand-light hover:text-brand-primary"}
                  `,children:m},m))})]})]})},pt=({className:e="",text:s,onClick:a,onCheckIn:r,onWeeklySummary:l,onTodayAction:n,onSafety:c})=>{if(s&&a)return t.jsx(x.button,{onClick:a,whileHover:{scale:1.05},whileTap:{scale:.95},className:`
          flex items-center gap-2 px-4 py-2.5 rounded-full
          bg-white/80 backdrop-blur-sm border border-slate-200/60
          text-slate-700 hover:text-brand-primary hover:border-brand-primary/50
          font-medium text-xs
          whitespace-nowrap
          shadow-sm hover:shadow-md
          transition-all duration-300
          min-w-fit
          h-10
        `,children:t.jsx("span",{children:s})});const d=[{id:"checkin",label:"오늘 체크인",icon:t.jsx(be,{size:16,strokeWidth:2}),onClick:r,color:"bg-brand-primary"},{id:"summary",label:"이번 주 요약",icon:t.jsx(Ke,{size:16,strokeWidth:2}),onClick:l,color:"bg-brand-secondary"},{id:"action",label:"오늘 1개",icon:t.jsx(J,{size:16,strokeWidth:2}),onClick:n,color:"bg-brand-accent"},{id:"safety",label:"안전 도움",icon:t.jsx(Xe,{size:16,strokeWidth:2}),onClick:c,color:"bg-red-500"}];return t.jsx("div",{className:`flex gap-2 overflow-x-auto scrollbar-hide pb-2 ${e}`,children:d.map(i=>t.jsxs(x.button,{onClick:i.onClick,whileHover:{scale:1.05},whileTap:{scale:.95},className:`
            flex items-center gap-2 px-4 py-2.5 rounded-full
            ${i.color} text-white
            font-bold text-xs
            whitespace-nowrap
            shadow-sm hover:shadow-md
            transition-all duration-300
            min-w-24
            h-12
          `,children:[i.icon,t.jsx("span",{children:i.label})]},i.id))})},ut=({actionTitle:e,onComplete:s,onSkip:a})=>{const[r,l]=o.useState("before"),[n,c]=o.useState(null),[d,i]=o.useState(null),g=j=>{c(j),l("after")},S=j=>{i(j),l("result")},h=()=>{l("after"),i(null)},A=()=>{n!==null&&d!==null&&s(n,d)},b=n===null||d===null?null:d-n;return t.jsx("div",{className:"w-full max-w-md mx-auto space-y-6",children:t.jsxs(P,{mode:"wait",children:[r==="before"&&t.jsxs(x.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2",children:"액션 시작 전"}),t.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"지금 감정 강도는 어느 정도인가요?"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"강도"}),t.jsxs("span",{className:"text-xl font-bold text-brand-primary",children:[n!==null?n:"-","/10"]})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:n||5,onChange:j=>c(Number(j.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-primary"}),t.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[t.jsx("span",{children:"1"}),t.jsx("span",{children:"5"}),t.jsx("span",{children:"10"})]}),t.jsx(_,{onClick:()=>g(n||5),variant:"primary",className:"w-full",children:"다음 단계로"}),a&&t.jsx(_,{onClick:a,variant:"ghost",className:"w-full",children:"스킵"})]})]},"before"),r==="after"&&t.jsxs(x.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2",children:"액션 완료 후"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:[e,"를 완료한 후 감정 강도는 어느 정도인가요?"]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"강도"}),t.jsxs("span",{className:"text-xl font-bold text-brand-primary",children:[d!==null?d:"-","/10"]})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:d||n||5,onChange:j=>i(Number(j.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-primary"}),t.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[t.jsx("span",{children:"1"}),t.jsx("span",{children:"5"}),t.jsx("span",{children:"10"})]}),t.jsx(_,{onClick:()=>S(d||n||5),variant:"primary",className:"w-full",children:"결과 보기"}),t.jsxs(_,{onClick:h,variant:"ghost",className:"w-full",children:[t.jsx(Je,{size:16,className:"mr-2"}),"5초 후 다시 체크"]})]})]},"after"),r==="result"&&b!==null&&t.jsxs(x.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.05},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2 text-center",children:"변화 결과"}),t.jsxs("div",{className:"flex items-center justify-center gap-4 my-6",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-3xl font-bold text-slate-700 mb-1",children:n}),t.jsx("div",{className:"text-xs text-slate-500",children:"Before"})]}),t.jsxs("div",{className:`
                flex items-center gap-2 px-4 py-2 rounded-full
                ${b>0?"bg-green-100 text-green-700":b<0?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"}
              `,children:[b>0?t.jsx(qe,{size:24}):b<0?t.jsx(Qe,{size:24}):t.jsx(Ze,{size:24}),t.jsx("span",{className:"text-xl font-bold",children:b>0?`+${b}`:b})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-3xl font-bold text-slate-700 mb-1",children:d}),t.jsx("div",{className:"text-xs text-slate-500",children:"After"})]})]}),t.jsx("div",{className:"text-center mb-6",children:b>0?t.jsxs("p",{className:"text-sm text-green-700 font-medium",children:["감정 강도가 ",b,"점 상승했어요"]}):b<0?t.jsxs("p",{className:"text-sm text-blue-700 font-medium",children:["감정 강도가 ",Math.abs(b),"점 하락했어요"]}):t.jsx("p",{className:"text-sm text-slate-600 font-medium",children:"감정 강도가 유지되었어요"})}),t.jsxs(_,{onClick:A,variant:"primary",className:"w-full",children:[t.jsx(je,{size:18,className:"mr-2"}),"완료"]})]},"result")]})})},yt={type:"idle"};function xt(e,s){if(s.type==="CRISIS_DETECTED"&&e.type!=="idle"&&e.type!=="completed"&&e.type!=="error")return{type:"crisis_detected",returnState:e};if(e.type==="crisis_detected"&&s.type==="CRISIS_HANDLED")return e.returnState;if(s.type==="RESET")return{type:"idle"};switch(e.type){case"idle":if(s.type==="OPEN_EMOTION_MODAL")return{type:"emotion_modal_open"};break;case"emotion_modal_open":if(s.type==="SELECT_EMOTION")return{type:"emotion_selected",emotion:s.emotion,intensity:5};break;case"emotion_selected":if(s.type==="CHANGE_INTENSITY")return{type:"emotion_selected",emotion:e.emotion,intensity:s.intensity};if(s.type==="SELECT_EMOTION")return{type:"emotion_selected",emotion:s.emotion,intensity:e.intensity};if(s.type==="CONFIRM_EMOTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[],input:""};break;case"chatting":if(s.type==="UPDATE_INPUT")return{...e,input:s.input};if(s.type==="SEND_MESSAGE"){const a={id:Date.now().toString(),role:"user",content:s.message,timestamp:new Date};return{type:"ai_responding",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a].slice(-100)}}if(s.type==="SHOW_TAG_STEP")return{type:"tag_selecting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[]};if(s.type==="REQUEST_SAVE")return{type:"saving",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[],retryCount:0};if(s.type==="GENERATE_ACTION")return{type:"action_loading",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[]};break;case"ai_responding":if(s.type==="AI_RESPONSE_SUCCESS"){const a={id:(Date.now()+1).toString(),role:"assistant",content:s.response,timestamp:new Date};return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a].slice(-100),input:""}}if(s.type==="AI_RESPONSE_ERROR"){const a={id:(Date.now()+1).toString(),role:"assistant",content:s.error||"연결에 문제가 발생했습니다. 잠시 후 다시 시도해주세요.",timestamp:new Date};return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a],input:""}}break;case"tag_selecting":if(s.type==="UPDATE_TAGS")return{...e,tags:s.tags};if(s.type==="REQUEST_SAVE")return{type:"saving",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,retryCount:0};break;case"saving":if(s.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags};if(s.type==="SAVE_RETRY")return{...e,retryCount:s.retryCount};if(s.type==="SAVE_ERROR")return{type:"error",error:s.error};break;case"saved":if(s.type==="GENERATE_ACTION")return{type:"action_loading",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags};if(s.type==="COMPLETE")return{type:"completed"};break;case"action_loading":if(s.type==="ACTION_LOADED")return{type:"action_showing",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,actionId:s.actionId,actionTitle:s.actionTitle,actionDescription:s.actionDescription,actionDuration:s.actionDuration};if(s.type==="ACTION_LOAD_ERROR")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break;case"action_showing":if(s.type==="START_ACTION_FEEDBACK")return{type:"action_feedback",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,actionId:e.actionId,actionTitle:e.actionTitle};if(s.type==="DISMISS_ACTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break;case"action_feedback":if(s.type==="COMPLETE_ACTION_FEEDBACK")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};if(s.type==="SKIP_ACTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break}return e}function U(e){return"emotion"in e?e.emotion:null}function V(e){return"intensity"in e?e.intensity:5}function W(e){return"messages"in e?e.messages:[]}function oe(e){return"tags"in e?e.tags:[]}function ht(e){return"input"in e?e.input:""}function le(e){return e.type==="action_showing"||e.type==="action_feedback"?{id:e.actionId,title:e.actionTitle,description:"actionDescription"in e?e.actionDescription:"",duration:"actionDuration"in e?e.actionDuration:""}:null}const ce=e=>e.type==="idle",gt=e=>e.type==="emotion_modal_open",ft=e=>e.type==="emotion_selected",bt=e=>e.type==="chatting",jt=e=>e.type==="ai_responding",Nt=e=>e.type==="tag_selecting",wt=e=>e.type==="saving",St=e=>e.type==="saved",Et=e=>e.type==="action_loading",Ct=e=>e.type==="action_showing",Tt=e=>e.type==="action_feedback",At=e=>e.type==="completed",vt=e=>e.type==="crisis_detected",kt=e=>e.type==="error",It=["자해","자상","칼","약물 과다복용","약물과다복용","약물과다","목매기","손목","약 먹고 싶다","자해하고 싶다","자해하고싶다","자해하고 싶어","자해하고싶어","자해할까","자해할까?","상처","피","아프게","고통","참을 수 없어","죽고 싶다","죽고싶다","죽고 싶어","죽고싶어","죽고 싶어요","죽고싶어요","끝내고 싶다","끝내고싶다","끝내고 싶어","끝내고싶어","더 이상 못 살겠다","더이상 못 살겠다","못 살겠다","못살겠다","생명을 끊고 싶다","생명을 끊고싶다","생명 끊고 싶다","자살하고 싶다","자살하고싶다","자살하고 싶어","자살하고싶어","자살할까","자살할까?","자살 생각","자살생각","죽음","죽을래","죽을래요","죽고 싶어요","끝","끝내고 싶어요","끝내고싶어요","도와줘","도와주세요","구해줘","구해주세요","힘들어","힘들어요","버틸 수 없어","버틸수없어","포기하고 싶어","포기하고싶어","포기할래"],se=[O.ANXIETY,O.SADNESS,O.ANGER];function _t(e){if(!e||e.trim().length===0)return{isCrisis:!1,reason:"none",confidence:"low"};const s=e.toLowerCase(),a=s.replace(/\s+/g,""),r=It.filter(l=>{const n=l.toLowerCase().replace(/\s+/g,"");return a.includes(n)||s.includes(l.toLowerCase())});return r.length>0?{isCrisis:!0,reason:"keyword",confidence:r.length>=2?"high":"medium",details:`감지된 키워드: ${r.join(", ")}`}:{isCrisis:!1,reason:"none",confidence:"low"}}function Rt(e,s){return se.includes(e)&&s>=9?{isCrisis:!0,reason:"intensity",confidence:s===10?"high":"medium",details:`${e} 감정, 강도 ${s}`}:{isCrisis:!1,reason:"none",confidence:"low"}}function Mt(e){if(e.length===0)return{isCrisis:!1,reason:"none",confidence:"low"};const s=e.filter(n=>{const c=se.includes(n.emotion),d=n.intensity>=8;return c&&d}),a=new Set;if(s.forEach(n=>{const c=n.timestamp.toISOString().split("T")[0];a.add(c)}),a.size>=3)return{isCrisis:!0,reason:"pattern",confidence:a.size>=5?"high":"medium",details:`연속 ${a.size}일간 부정적 감정 강도 8 이상`};if(e.length>=2){const n=e[0],c=e[1];if((n.timestamp.getTime()-c.timestamp.getTime())/(1e3*60*60*24)<=1){const g=n.intensity-c.intensity;if(c.intensity<=3&&n.intensity>=9&&g>=6)return{isCrisis:!0,reason:"pattern",confidence:"medium",details:`급격한 감정 변화: 강도 ${c.intensity} → ${n.intensity}`}}}const r=e.filter(n=>{const c=se.includes(n.emotion),d=n.intensity>=7;return c&&d}),l=new Set;return r.forEach(n=>{const c=n.timestamp.toISOString().split("T")[0];l.add(c)}),l.size>=7?{isCrisis:!0,reason:"pattern",confidence:"medium",details:`${l.size}일간 부정적 감정 강도 7 이상 지속`}:{isCrisis:!1,reason:"none",confidence:"low"}}async function de(e){try{const s=`다음 메시지가 자해/자살 위험을 나타내는지 분석해주세요.

메시지: "${e}"

응답 형식 (JSON만 반환):
{
  "isCrisis": true 또는 false,
  "severity": "none" | "low" | "medium" | "high" | "critical",
  "reason": "판단 이유 한 줄"
}

기준:
- none: 위기 신호 없음
- low: 막연한 불안, 피로, 일반적인 부정 감정
- medium: 구체적 부정 감정, "희망 없음" 표현
- high: 자해/자살 간접 암시 ("더 이상 살 의미가 없어" 등)
- critical: 자해/자살 직접적 의도 또는 구체적 계획

JSON만 반환하세요:`,r=await Te(s,[],{name:"분석기",role:"counselor",mbti:"INFJ",traits:{warmth:50,directness:50}}),l=r.match(/\{[\s\S]*\}/);if(!l)throw console.warn("Gemini 응답이 JSON 형식이 아님:",r),new Error("JSON 응답 형식 아님");return JSON.parse(l[0])}catch(s){return console.error("Gemini 위기 감지 실패:",s),{isCrisis:!1,severity:"none"}}}async function z(e){const{text:s,emotion:a,intensity:r,recentEntries:l=[]}=e;if(s){const n=_t(s);if(n.isCrisis){console.log("위기 키워드 감지, Gemini로 2차 검증 시작...");const c=await de(s);return c.severity==="critical"||c.severity==="high"?{isCrisis:!0,reason:"gemini",confidence:"high",details:c.reason||"심각한 위기 신호 감지 (Gemini 분석)"}:c.severity==="medium"&&r&&r>=8?{isCrisis:!0,reason:"gemini",confidence:"medium",details:c.reason||"위기 신호 + 높은 감정 강도"}:c.severity==="none"||c.severity==="low"?(console.log("키워드 오탐지 (Gemini 분석: 위기 아님)"),{isCrisis:!1,reason:"none",confidence:"low",details:"Gemini 검증: 위기 아님"}):n}}if(a&&r!==void 0){const n=Rt(a,r);if(n.isCrisis){if(s){console.log("강도 기반 감지, Gemini로 재확인...");const c=await de(s);if(c.severity==="critical"||c.severity==="high")return{isCrisis:!0,reason:"gemini",confidence:"high",details:c.reason||"간접적 위기 신호 감지 (Gemini 분석)"}}return n}}if(l.length>0){const n=Mt(l);if(n.isCrisis)return n}return{isCrisis:!1,reason:"none",confidence:"low"}}const Dt=[{id:"MA-001",title:"2분 박스 호흡",description:"4초 들이마시기 → 4초 멈춤 → 4초 내쉬기 → 4초 멈춤. 4번 반복.",duration:"2 min",type:"breathing"},{id:"MA-002",title:"4-6 호흡(긴 내쉬기)",description:"4초 들이마시고 6초 내쉬기. 8번 반복.",duration:"2 min",type:"breathing"},{id:"MA-003",title:"긴 내쉬기 10번",description:'숨을 편하게 들이마신 뒤, 내쉬는 호흡을 "조금 더 길게" 10번.',duration:"2 min",type:"breathing"},{id:"MA-004",title:"5-4-3-2-1 감각 체크",description:"보이는 것 5개, 만져지는 것 4개, 들리는 것 3개, 냄새 2개, 맛 1개를 조용히 확인.",duration:"3 min",type:"breathing"},{id:"MA-005",title:"손을 가슴에(자기 체크)",description:'한 손을 가슴에 두고 "지금 이 순간"에 집중하며 호흡 10번.',duration:"2 min",type:"breathing"},{id:"MA-006",title:"1분 바디 스캔 + 1분 호흡",description:"머리→어깨→가슴→배→다리 순서로 긴장 부위를 찾고, 마지막 1분은 호흡만.",duration:"2 min",type:"breathing"},{id:"MA-007",title:"3문장 마음 정리",description:'"지금 느끼는 감정은 ___.", "몸은 ___.", "다음에 필요한 건 ___." 3문장만 작성.',duration:"3 min",type:"breathing"},{id:"MA-008",title:"어깨/목 풀기(3분)",description:"어깨를 10번 돌리고, 목을 좌/우 천천히 10초씩. 마지막에 깊게 기지개.",duration:"3 min",type:"exercise"},{id:"MA-009",title:"3분 걷기",description:"집/사무실에서라도 3분만 천천히 걷기. 걸으며 발바닥 감각에 집중.",duration:"3 min",type:"exercise"},{id:"MA-010",title:"전신 기지개 2분",description:"팔을 머리 위로 올려 10초 유지 → 옆구리 늘리기 좌/우 → 몸통 비틀기.",duration:"2 min",type:"exercise"},{id:"MA-011",title:"손목/등 스트레칭",description:"손목을 가볍게 풀고, 등(견갑)을 30초씩 늘리기.",duration:"2 min",type:"exercise"},{id:"MA-012",title:"제자리 걷기(4분)",description:"1분 제자리 걷기 + 30초 쉬기 × 2세트. 숨이 너무 차지 않게.",duration:"4 min",type:"exercise"},{id:"MA-013",title:"물 한 잔 + 자세 리셋",description:"물 한 잔 마시고, 의자에 앉아 골반/등/목을 곧게 30초 유지.",duration:"3 min",type:"exercise"},{id:"MA-014",title:"감정 이름 붙이기",description:'"나는 지금 ___을 느낀다" 한 줄 + 이유(한 줄)만.',duration:"2 min",type:"journaling"},{id:"MA-015",title:"오늘 잘한 것 1개",description:'오늘 내가 한 "작은 성공" 1가지만 적기.',duration:"2 min",type:"journaling"},{id:"MA-016",title:"감사 1줄",description:"감사한 것 1개를 1줄로 적기(사람/상황/나 자신).",duration:"2 min",type:"journaling"},{id:"MA-017",title:'다음 "가장 작은 한 걸음"',description:'지금 해야 할 일/목표가 있다면 "5분 안에 가능한 1단계"를 적고, 시작 버튼만 누르기(실행은 선택).',duration:"3 min",type:"journaling"},{id:"MA-018",title:"머릿속 비우기 3줄",description:'떠오르는 생각을 3줄로 적고, 마지막 줄에 "지금은 여기까지"라고 마무리.',duration:"3 min",type:"journaling"},{id:"MA-019",title:"걱정 타임박스",description:'걱정을 2분 동안 적고, 마지막 1분은 "다음에 할 수 있는 1개"만 적기.',duration:"3 min",type:"journaling"},{id:"MA-020",title:"오늘의 우선순위 1개",description:"오늘 가장 중요한 것 1개만 정하고, 나머지는 잠시 내려놓기.",duration:"2 min",type:"journaling"},{id:"MA-021",title:"하루 마무리 한 줄",description:'"오늘의 나에게 한 줄"을 쓰기.',duration:"2 min",type:"journaling"},{id:"MA-022",title:"고마움 메시지 1개",description:'고마운 사람에게 짧게 "고마웠어" 한 문장 보내기(길게 X).',duration:"2 min",type:"mindfulness"},{id:"MA-023",title:"나에게 응원 한 줄",description:'"나는 지금도 충분히 하고 있어"처럼 나에게 한 문장.',duration:"2 min",type:"mindfulness"},{id:"MA-024",title:"안부 한 줄(가벼운 연결)",description:"부담 없는 안부 1줄 보내기(답을 기대하지 않기).",duration:"3 min",type:"mindfulness"},{id:"MA-025",title:"미소/표정 풀기",description:"턱/미간 힘을 풀고, 어깨를 내리며 10초 미소.",duration:"2 min",type:"mindfulness"},{id:"MA-026",title:"책상 위 2분 정리",description:'눈에 보이는 3가지만 제자리로. 끝나면 "완료"만 누르기.',duration:"2 min",type:"mindfulness"},{id:"MA-027",title:"창문 열기 + 공기 바꾸기",description:"창문을 열고 10번 천천히 호흡. 창문이 없다면 자리에서 몸을 펴기.",duration:"2 min",type:"mindfulness"},{id:"MA-028",title:"빛/소리 세팅",description:"화면 밝기/조명 조정, 불필요한 알림 끄기(10분만).",duration:"3 min",type:"mindfulness"},{id:"MA-029",title:"내일을 위한 1분 준비",description:"내일의 첫 할 일 1개를 적고(1분), 필요한 것 1가지만 꺼내두기(2분).",duration:"3 min",type:"journaling"},{id:"MA-030",title:"좋아하는 음악 1곡",description:"좋아하는 음악 1곡을 들으며 호흡/몸 감각만 느끼기.",duration:"3 min",type:"mindfulness"}],$=e=>Dt.filter(s=>s.type===e),Ot=e=>e>=8?$("breathing").slice(0,3):e>=5?[...$("breathing").slice(0,2),...$("exercise").slice(0,2)]:[...$("journaling").slice(0,2),...$("mindfulness").slice(0,2)],zt=(e,s)=>{const a=Ot(s);return e==="JOY"||e==="PEACE"?[...$("mindfulness").slice(0,2),...$("journaling").slice(0,2),...a.slice(0,1)]:e==="ANXIETY"||e==="SADNESS"?[...$("journaling").slice(0,2),...$("mindfulness").slice(0,2),...a.slice(0,1)]:a};function $t(e){const{persona:s,onCrisisDetected:a,onComplete:r,onEmotionChange:l}=e,[n,c]=o.useReducer(xt,yt),d=o.useRef(null),i=o.useCallback(y=>{c(y)},[]),g=o.useCallback(()=>{i({type:"OPEN_EMOTION_MODAL"})},[i]),S=o.useCallback(async y=>{i({type:"SELECT_EMOTION",emotion:y}),l==null||l(y);const w=V(n);(await z({emotion:y,intensity:w})).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,n,a,l]),h=o.useCallback(async y=>{i({type:"CHANGE_INTENSITY",intensity:y});const w=U(n);w&&(await z({emotion:w,intensity:y})).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,n,a]),A=o.useCallback(()=>{i({type:"CONFIRM_EMOTION"}),l==null||l(U(n))},[i,n,l]),f=o.useCallback(y=>{i({type:"UPDATE_INPUT",input:y})},[i]),b=o.useCallback(async y=>{if(!y.trim())return;if((await z({text:y})).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"SEND_MESSAGE",message:y});const D=W(n).map(T=>`${T.role==="user"?"사용자":s.name}: ${T.content}`);try{const T=await Ae(y,D,s);i({type:"AI_RESPONSE_SUCCESS",response:T})}catch(T){const G=T instanceof Error?T.message:"연결에 문제가 발생했습니다.";i({type:"AI_RESPONSE_ERROR",error:G})}},[i,n,s,a]),j=o.useCallback(()=>{i({type:"SHOW_TAG_STEP"})},[i]),m=o.useCallback(y=>{i({type:"UPDATE_TAGS",tags:y})},[i]),E=o.useCallback(async()=>{const y=U(n),w=V(n),I=W(n),D=oe(n);if(!y)return;const T=I.map(L=>`[${L.role==="user"?"나":s.name}]: ${L.content}`).join(`

`),G=await ge(7);if((await z({text:T,emotion:y,intensity:w,recentEntries:G})).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"REQUEST_SAVE"});let H=0;const ne=3;for(;H<=ne;)try{const L=I.length>0?I[0].content.slice(0,30):"체크인",q=await ve({title:L,messages:I.map(Y=>({role:Y.role,content:Y.content})),emotion:y,intensity:w,modeAtTime:"day",contextTags:D.length>0?D:void 0});await fe({emotion:y,intensity:w,modeAtTime:"day",contextTags:D.length>0?D:void 0,conversationId:q||void 0}),i({type:"SAVE_SUCCESS"});const Q={id:Date.now().toString(),date:new Date,type:"day",emotion:y,intensity:w,summary:L,detail:T,nuanceTags:D};r==null||r(Q);return}catch(L){H++;const q=L instanceof Error?L.message:"저장 실패";if(H<=ne){const Q=Math.pow(2,H-1)*1e3;await new Promise(Y=>setTimeout(Y,Q)),i({type:"SAVE_RETRY",retryCount:H})}else i({type:"SAVE_ERROR",error:q})}},[n,i,s,a,r]),p=o.useCallback(async()=>{const y=U(n),w=V(n),I=W(n);if(y){i({type:"GENERATE_ACTION"});try{const D=zt(y,w);let T;D.length>0?T=D[0]:T=await ke(y,w,I.map(G=>G.content).join(" ")),i({type:"ACTION_LOADED",actionId:T.id,actionTitle:T.title,actionDescription:T.description,actionDuration:T.duration})}catch{i({type:"ACTION_LOAD_ERROR"})}}},[n,i]),N=o.useCallback(()=>{i({type:"START_ACTION_FEEDBACK"})},[i]),M=o.useCallback(async(y,w)=>{const I=le(n);if(I)try{await Ie({actionId:I.id,actionTitle:I.title,beforeIntensity:y,afterIntensity:w,completed:!0,skipped:!1})}catch(D){console.error("Error saving micro action log:",D)}i({type:"COMPLETE_ACTION_FEEDBACK",before:y,after:w})},[n,i]),C=o.useCallback(()=>{i({type:"SKIP_ACTION"})},[i]),R=o.useCallback(()=>{i({type:"DISMISS_ACTION"})},[i]),k=o.useCallback(()=>{i({type:"CRISIS_HANDLED"})},[i]),u=o.useCallback(()=>{i({type:"COMPLETE"})},[i]),v=o.useCallback(()=>{d.current&&(clearTimeout(d.current),d.current=null),i({type:"RESET"})},[i]);return o.useEffect(()=>()=>{d.current&&clearTimeout(d.current)},[]),o.useEffect(()=>{ce(n)&&g()},[]),{state:n,isIdle:ce(n),isEmotionModalOpen:gt(n),isEmotionSelected:ft(n),isChatting:bt(n),isAIResponding:jt(n),isTagSelecting:Nt(n),isSaving:wt(n),isSaved:St(n),isActionLoading:Et(n),isActionShowing:Ct(n),isActionFeedback:Tt(n),isCompleted:At(n),isCrisisDetected:vt(n),isError:kt(n),emotion:U(n),intensity:V(n),messages:W(n),tags:oe(n),input:ht(n),action:le(n),openEmotionModal:g,selectEmotion:S,changeIntensity:h,confirmEmotion:A,updateInput:f,sendMessage:b,showTagStep:j,updateTags:m,requestSave:E,generateAction:p,startActionFeedback:N,completeActionFeedback:M,skipAction:C,dismissAction:R,handleCrisisHandled:k,complete:u,reset:v}}const Lt=[{id:O.JOY,label:"완전 최고",icon:t.jsx(Ne,{size:36,strokeWidth:2}),color:"text-amber-500",bgGradient:"from-amber-200/40 via-yellow-100/40 to-orange-100/40"},{id:O.PEACE,label:"괜찮아요",icon:t.jsx(we,{size:36,strokeWidth:2}),color:"text-brand-primary",bgGradient:"from-brand-secondary/40 via-teal-100/40 to-cyan-100/40"},{id:O.ANXIETY,label:"조금 불안해요",icon:t.jsx(Se,{size:36,strokeWidth:2}),color:"text-orange-500",bgGradient:"from-orange-200/40 via-red-100/40 to-amber-100/40"},{id:O.SADNESS,label:"우울해요",icon:t.jsx(Ee,{size:36,strokeWidth:2}),color:"text-indigo-500",bgGradient:"from-indigo-200/40 via-purple-100/40 to-slate-100/40"},{id:O.ANGER,label:"화가 나요",icon:t.jsx(Ce,{size:36,strokeWidth:2}),color:"text-rose-500",bgGradient:"from-rose-200/40 via-red-100/40 to-orange-100/40"}],Ft=[{id:"1",text:"오늘 하루는 어땠어요?",emotion:null},{id:"2",text:"무엇이 기분에 영향을 줬나요?",emotion:null},{id:"3",text:"지금 가장 필요한 건 뭐예요?",emotion:null}],Z=1e4,Pt=9e3,Gt=({persona:e,onSave:s,setImmersive:a,onNavigateToReports:r,onOpenSafety:l,onCrisisDetected:n,onEmotionChange:c})=>{const{triggerHaptic:d}=_e(),i=$t({persona:e,onCrisisDetected:n,onComplete:s,onEmotionChange:c}),g=o.useRef(null),S=o.useRef(null),h=Lt.find(u=>u.id===i.emotion),A=()=>{var u;(u=g.current)==null||u.scrollIntoView({behavior:"smooth"})};o.useEffect(A,[i.messages,i.isAIResponding]),o.useEffect(()=>()=>{a(!1)},[a]);const f=()=>{i.confirmEmotion(),a(!0),d("medium")},b=u=>{i.selectEmotion(u),d("medium")},j=u=>{i.changeIntensity(u),d("light")},m=u=>{var v;i.updateInput(u),(v=S.current)==null||v.focus(),d("light")},E=async()=>{i.input.trim()&&(d("light"),await i.sendMessage(i.input))},p=async()=>{if(!(i.isSaved||i.isActionLoading)){if(!i.isTagSelecting&&i.tags.length===0){i.showTagStep();return}a(!1),await i.requestSave()}},N=async(u,v)=>{await i.completeActionFeedback(u,v)},M=i.isEmotionModalOpen||i.isEmotionSelected,C=i.isChatting||i.isAIResponding||i.isTagSelecting||i.isSaving||i.isSaved||i.isActionLoading||i.isActionShowing||i.isActionFeedback,R=i.isChatting&&i.messages.length>0&&!i.isAIResponding;o.useEffect(()=>{C&&a(!0)},[C,a]);const k=C&&i.messages.length===0?[{id:"greeting",role:"assistant",content:`안녕하세요! ${e.name}입니다. ${h==null?void 0:h.label} 기분이시군요. 어떤 이야기를 나눠볼까요?`,timestamp:new Date}]:i.messages;return t.jsxs(t.Fragment,{children:[t.jsx(Re,{isOpen:M,selectedEmotion:i.emotion,intensity:i.intensity,onEmotionSelect:b,onIntensityChange:j,onComplete:f}),t.jsx(P,{children:C&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.5,ease:[.16,1,.3,1]},className:"flex flex-col h-full w-full bg-gradient-to-b from-white/60 to-white/40",children:[t.jsxs(x.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},className:"shrink-0 flex items-center justify-between px-6 py-5 sm:px-8 sm:py-6 border-b border-slate-200/30 bg-white/50 backdrop-blur-xl",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[h&&t.jsx(x.div,{className:`${h.color} p-2 rounded-xl bg-white/60 backdrop-blur-sm shadow-sm`,whileHover:{scale:1.05},whileTap:{scale:.95},children:h.icon}),t.jsxs("div",{children:[t.jsx("h2",{className:"font-bold text-lg text-slate-800",children:(h==null?void 0:h.label)||"감정 체크인"}),t.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(et,{size:12,className:"text-rose-400 fill-rose-400"}),t.jsxs("span",{className:"text-xs text-slate-500",children:["강도: ",i.intensity,"/10"]})]}),t.jsx("span",{className:"text-xs text-slate-400",children:"•"}),t.jsx("span",{className:"text-xs text-slate-500",children:e.name})]})]})]}),t.jsx("button",{onClick:()=>a(!1),className:"p-2 rounded-full hover:bg-white/60 transition-colors text-slate-600","aria-label":"닫기",children:t.jsx(ie,{size:20})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-6 sm:px-8 sm:py-8 space-y-5 scrollbar-hide min-h-0",children:[k.map((u,v)=>t.jsx(x.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:v*.05},className:`flex ${u.role==="user"?"justify-end":"justify-start"}`,children:t.jsxs(x.div,{className:`
                      max-w-chat-bubble sm:max-w-chat-bubble-sm rounded-2xl px-5 py-4 shadow-lg
                      ${u.role==="user"?"bg-gradient-to-br from-brand-primary to-brand-secondary text-white shadow-brand-primary/25":"bg-white/90 backdrop-blur-xl text-slate-900 border border-white/70 shadow-slate-300/30"}
                    `,whileHover:{scale:1.01},transition:{type:"spring",stiffness:400,damping:20},children:[u.role==="assistant"&&t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("div",{className:"w-6 h-6 rounded-full bg-gradient-to-br from-brand-primary to-brand-secondary flex items-center justify-center shadow-sm",children:t.jsx(be,{size:13,className:"text-white"})}),t.jsx("span",{className:"text-xs font-bold text-brand-primary",children:e.name})]}),t.jsx("p",{className:`text-base leading-relaxed ${u.role==="user"?"text-white":"text-slate-700"}`,children:u.content})]})},u.id)),i.isAIResponding&&t.jsx(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex justify-start",children:t.jsx("div",{className:"bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/60 p-3",children:t.jsx(ot,{})})}),t.jsx("div",{ref:g})]}),t.jsx(P,{children:R&&t.jsx(x.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"shrink-0 px-6 sm:px-8 pb-3",children:t.jsx("div",{className:"flex gap-3 overflow-x-auto scrollbar-hide pb-2",children:Ft.map(u=>t.jsx(pt,{text:u.text,onClick:()=>m(u.text)},u.id))})})}),t.jsxs(P,{children:[i.isActionShowing&&i.action&&t.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"shrink-0 px-6 py-5 sm:px-8 sm:py-6 border-t border-slate-200/30 bg-white/50 backdrop-blur-xl",children:t.jsxs(te,{className:"p-4",children:[t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(J,{size:18,className:"text-brand-primary"}),t.jsx("h3",{className:"font-bold text-lg text-slate-800",children:"오늘의 작은 실천"})]}),t.jsx("p",{className:"text-sm text-slate-600 leading-relaxed",children:i.action.description})]}),t.jsx("button",{onClick:i.dismissAction,className:"p-1 rounded-full hover:bg-slate-100 transition-colors text-slate-400","aria-label":"액션 카드 닫기",children:t.jsx(ie,{size:18})})]}),t.jsxs(_,{variant:"primary",className:"w-full",onClick:i.startActionFeedback,"aria-label":`${i.action.title} 시도해보기`,children:["시도해보기 (",i.action.duration,")"]})]})}),i.isActionFeedback&&i.action&&t.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"shrink-0 px-6 py-5 sm:px-8 sm:py-6 border-t border-slate-200/30 bg-white/50 backdrop-blur-xl",children:t.jsx(ut,{actionTitle:i.action.title,onComplete:N,onSkip:i.skipAction})})]}),i.isTagSelecting&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"shrink-0 px-6 py-5 sm:px-8 sm:py-6 border-t border-slate-200/30 bg-white/50 backdrop-blur-xl",children:[t.jsx(mt,{onTagsChange:i.updateTags,initialTags:i.tags,locationPermission:"granted"}),t.jsxs("div",{className:"flex gap-2 mt-4",children:[t.jsx(_,{onClick:p,variant:"primary",className:"flex-1","aria-label":"체크인 완료 및 저장",children:"저장하기"}),t.jsx(_,{onClick:p,variant:"ghost",children:"스킵"})]})]}),i.isChatting&&!i.isTagSelecting&&(()=>{const u=Z-i.input.length,v=u<=Z-Pt,y=u<=0;return t.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"shrink-0 px-6 py-5 sm:px-8 sm:py-6 border-t border-slate-200/30 bg-white/50 backdrop-blur-xl",children:t.jsx("div",{className:"flex gap-3",children:t.jsxs("div",{className:"flex-1 relative",children:[t.jsx("input",{ref:S,type:"text",maxLength:Z,value:i.input,onChange:w=>i.updateInput(w.target.value),onKeyPress:w=>w.key==="Enter"&&!w.shiftKey&&E(),placeholder:"무엇이든 편하게 말씀해주세요...",className:"w-full px-5 py-4 pr-14 rounded-2xl bg-white/90 backdrop-blur-sm border border-slate-200/50 focus:outline-none focus:ring-2 focus:ring-brand-primary/40 focus:border-brand-primary/40 text-slate-800 placeholder-slate-400 transition-all text-base shadow-sm","aria-label":"메시지 입력","aria-describedby":v?"char-warning-day":void 0}),t.jsx("button",{onClick:E,disabled:!i.input.trim(),className:"absolute right-3 top-1/2 -translate-y-1/2 p-2.5 rounded-xl bg-brand-700 text-white hover:bg-brand-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg","aria-label":"전송",children:t.jsx(tt,{size:18})}),v&&t.jsx("p",{id:"char-warning-day",role:"status","aria-live":"polite",className:`absolute -bottom-5 right-2 text-xs ${y?"text-status-error":"text-status-warning"}`,children:y?"최대 글자 수에 도달했습니다":`${u}자 남음`})]})})})})()]})})]})},Ht={type:"idle"};function Ut(e,s){if(s.type==="CRISIS_DETECTED"&&e.type!=="idle"&&e.type!=="saved"&&e.type!=="error")return{type:"crisis_detected",returnState:e};if(e.type==="crisis_detected"&&s.type==="CRISIS_HANDLED")return e.returnState;if(s.type==="RESET")return{type:"idle"};switch(e.type){case"idle":if(s.type==="START")return{type:"emotion_step",emotion:null,intensity:5};break;case"emotion_step":if(s.type==="SELECT_EMOTION")return{type:"emotion_step",emotion:s.emotion,intensity:e.intensity};if(s.type==="CHANGE_INTENSITY")return{type:"emotion_step",emotion:e.emotion,intensity:s.intensity};if(s.type==="NEXT_TO_DIARY"&&e.emotion)return{type:"diary_step",emotion:e.emotion,intensity:e.intensity,diary:"",dayModeSummary:s.dayModeSummary};break;case"diary_step":if(s.type==="UPDATE_DIARY")return{...e,diary:s.diary};if(s.type==="ANALYZE_DIARY")return{type:"analyzing",emotion:e.emotion,intensity:e.intensity,diary:e.diary,dayModeSummary:e.dayModeSummary};break;case"analyzing":if(s.type==="LETTER_SUCCESS")return{type:"letter_step",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:s.letter,dayModeSummary:e.dayModeSummary};if(s.type==="LETTER_ERROR")return{type:"letter_step",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:"오늘 하루도 수고하셨어요. 내일도 함께 걸어가요.",dayModeSummary:e.dayModeSummary};break;case"letter_step":if(s.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary};if(s.type==="SAVE_RETRY")return{type:"saving",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary,retryCount:s.retryCount};if(s.type==="SAVE_ERROR")return{type:"error",error:s.error};break;case"saving":if(s.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary};if(s.type==="SAVE_RETRY")return{...e,retryCount:s.retryCount};if(s.type==="SAVE_ERROR")return{type:"error",error:s.error};break;case"saved":if(s.type==="RESET")return{type:"idle"};break}return e}function B(e){return"emotion"in e?e.emotion:null}function K(e){return"intensity"in e?e.intensity:5}function ee(e){return"diary"in e?e.diary:""}function me(e){return"letter"in e?e.letter:""}function pe(e){if("dayModeSummary"in e)return e.dayModeSummary}const ue=e=>e.type==="idle",Yt=e=>e.type==="emotion_step",Vt=e=>e.type==="diary_step",Wt=e=>e.type==="analyzing",ye=e=>e.type==="letter_step",Bt=e=>e.type==="saving",Kt=e=>e.type==="saved",Xt=e=>e.type==="crisis_detected",Jt=e=>e.type==="error";function qt(e){switch(e.type){case"idle":case"emotion_step":case"crisis_detected":return"emotion";case"diary_step":case"analyzing":return"diary";case"letter_step":case"saving":case"saved":case"error":return"letter";default:return"emotion"}}function Qt(e){const{persona:s,onCrisisDetected:a,onComplete:r,onEmotionChange:l}=e,[n,c]=o.useReducer(Ut,Ht),d=o.useRef(!1),i=o.useCallback(p=>{c(p)},[]),g=o.useCallback(()=>{i({type:"START"})},[i]),S=o.useCallback(async p=>{i({type:"SELECT_EMOTION",emotion:p}),l==null||l(p);const N=K(n);(await z({emotion:p,intensity:N})).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,n,a,l]),h=o.useCallback(async p=>{i({type:"CHANGE_INTENSITY",intensity:p});const N=B(n);N&&(await z({emotion:N,intensity:p})).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,n,a]),A=o.useCallback(async()=>{let p;try{p=await Me()??void 0}catch(N){console.warn("Day Mode 요약 조회 실패:",N)}i({type:"NEXT_TO_DIARY",dayModeSummary:p})},[i]),f=o.useCallback(async p=>{i({type:"UPDATE_DIARY",diary:p}),p.length>10&&(await z({text:p})).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,a]),b=o.useCallback(async()=>{const p=ee(n),N=B(n),M=K(n);if(!p.trim()||!N)return;if((await z({text:p})).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"ANALYZE_DIARY"});try{const R=await De(p,s);i({type:"LETTER_SUCCESS",letter:R});const k=await ge(7);if((await z({text:p,emotion:N,intensity:M,recentEntries:k})).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}await j(R)}catch(R){const k=R instanceof Error?R.message:"편지 생성 실패";i({type:"LETTER_ERROR",error:k})}},[n,s,i,a]),j=o.useCallback(async p=>{if(d.current)return;const N=B(n),M=K(n),C=ee(n),R=pe(n);if(!N)return;let k=0;const u=3;for(;k<=u;)try{await Oe({content:C,emotion:N,intensity:M,letterContent:p,dayModeSummary:R}),d.current=!0,i({type:"SAVE_SUCCESS"});const v={id:Date.now().toString(),date:new Date,type:"night",emotion:N,intensity:M,summary:C.slice(0,40)+(C.length>40?"...":""),detail:`[감정]: ${N} (강도: ${M})
[나의 일기]
${C}

[${s.name}의 답장]
${p}`};r==null||r(v);return}catch(v){k++;const y=v instanceof Error?v.message:"저장 실패";if(k<=u){const w=Math.pow(2,k-1)*1e3;await new Promise(I=>setTimeout(I,w)),i({type:"SAVE_RETRY",retryCount:k})}else i({type:"SAVE_ERROR",error:y})}},[n,s,i,r]),m=o.useCallback(()=>{i({type:"CRISIS_HANDLED"})},[i]),E=o.useCallback(()=>{d.current=!1,i({type:"RESET"})},[i]);return o.useEffect(()=>{ue(n)&&g()},[]),o.useEffect(()=>{if(ye(n)&&!d.current){const p=me(n);p&&j(p)}},[n.type]),{state:n,currentStep:qt(n),isIdle:ue(n),isEmotionStep:Yt(n),isDiaryStep:Vt(n),isAnalyzing:Wt(n),isLetterStep:ye(n),isSaving:Bt(n),isSaved:Kt(n),isCrisisDetected:Xt(n),isError:Jt(n),emotion:B(n),intensity:K(n),diary:ee(n),letter:me(n),dayModeSummary:pe(n),start:g,selectEmotion:S,changeIntensity:h,nextToDiary:A,updateDiary:f,analyzeDiary:b,handleCrisisHandled:m,reset:E}}const X=[{id:O.JOY,label:"기쁨",icon:t.jsx(Ne,{size:40,strokeWidth:1.5}),color:"joy"},{id:O.PEACE,label:"평온",icon:t.jsx(we,{size:40,strokeWidth:1.5}),color:"peace"},{id:O.ANXIETY,label:"불안",icon:t.jsx(Se,{size:40,strokeWidth:1.5}),color:"anxiety"},{id:O.SADNESS,label:"슬픔",icon:t.jsx(Ee,{size:40,strokeWidth:1.5}),color:"sadness"},{id:O.ANGER,label:"분노",icon:t.jsx(Ce,{size:40,strokeWidth:1.5}),color:"anger"}],F=1e4,xe=9e3,Zt=({persona:e,onSave:s,onCrisisDetected:a,onEmotionChange:r})=>{const[l,n]=o.useState(!1),[c,d]=o.useState(0),i=Qt({persona:e,onCrisisDetected:a,onComplete:f=>{s(f),n(!0),setTimeout(()=>n(!1),3e3)},onEmotionChange:r}),g=i.currentStep;o.useEffect(()=>{if(i.emotion){const f=X.findIndex(b=>b.id===i.emotion);f!==-1&&d(f)}},[i.emotion]);const{containerRef:S}=ze({itemCount:X.length,selectedIndex:c,onSelectChange:d,onEnter:f=>{i.selectEmotion(X[f].id)},enabled:g==="emotion",columns:2,loop:!0,horizontal:!0,vertical:!0}),h=async()=>{g==="emotion"&&i.emotion&&await i.nextToDiary()},A=async()=>{i.diary.trim()&&await i.analyzeDiary()};return t.jsxs("div",{className:"w-full max-w-4xl mx-auto h-full flex flex-col px-4 text-white relative overflow-hidden",children:[t.jsx(rt,{intensity:"medium"}),t.jsxs("div",{className:"py-6 shrink-0 text-center",children:[t.jsxs("h2",{className:"text-2xl font-sans font-bold flex items-center justify-center gap-2 mb-2 drop-shadow-md",children:[t.jsx("span",{className:"text-purple-300",children:t.jsx(it,{size:20,fill:"currentColor"})}),g==="emotion"?"저녁 성찰":g==="diary"?"나의 이야기":"당신을 위한 편지"]}),t.jsx("p",{className:"text-white/60 text-sm font-medium",children:g==="emotion"?"오늘 하루 기분은 어떠셨나요?":g==="diary"?"모두 털어놓으세요. 밤이 듣고 있어요.":`${e.name}의 메시지`})]}),t.jsxs(P,{mode:"wait",children:[g==="emotion"&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"flex-1 flex flex-col justify-center items-center gap-8 max-w-2xl mx-auto w-full",children:[t.jsx("div",{ref:S,className:"grid grid-cols-2 md:grid-cols-3 gap-6 w-full",tabIndex:-1,children:X.map((f,b)=>{const j=i.emotion===f.id,m=c===b;return t.jsxs("button",{onClick:()=>{d(b),i.selectEmotion(f.id)},className:`
                                    aspect-square p-6 rounded-lg backdrop-blur-md border text-left transition-all duration-300 flex flex-col justify-center items-center gap-4 group
                                    focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-2 focus:ring-offset-transparent
                                    ${j?"bg-white/20 border-white/60 shadow-glow-white scale-105 ring-1 ring-white/50":"bg-white/5 border-white/5 hover:bg-white/10"}
                                    ${m&&!j?"ring-2 ring-white/30 ring-offset-2 ring-offset-transparent":""}
                                `,tabIndex:m?0:-1,children:[t.jsx("span",{className:"text-white/80 group-hover:scale-110 transition-transform duration-300",children:f.icon}),t.jsx("span",{className:"text-white/90 font-medium text-lg tracking-wide",children:f.label})]},f.id)})}),i.emotion&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white/5 backdrop-blur-xl rounded-lg p-8 border border-white/10 w-full",children:[t.jsxs("div",{className:"flex justify-between text-white font-bold mb-6",children:[t.jsx("span",{className:"text-xs uppercase tracking-wider text-purple-200",children:"감정 깊이"}),t.jsx("span",{className:"text-xl",children:i.intensity})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:i.intensity,onChange:f=>i.changeIntensity(Number(f.target.value)),className:"w-full h-2 bg-white/20 rounded-full appearance-none cursor-pointer accent-purple-300"}),t.jsxs(_,{onClick:h,className:"w-full mt-8 py-4 bg-purple-500 hover:bg-purple-600 border-none text-white font-bold text-lg shadow-xl shadow-purple-900/40","aria-label":"다음 단계로 계속하기",children:["계속하기 ",t.jsx(st,{size:20})]})]})]},"step-emotion"),g==="diary"&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"flex-1 flex flex-col gap-6 w-full max-w-3xl mx-auto pb-10",children:[i.dayModeSummary&&t.jsxs(x.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-purple-500/20 backdrop-blur-md rounded-lg p-4 border border-purple-300/20",children:[t.jsx("p",{className:"text-purple-200 text-sm font-medium mb-1",children:"오늘 낮의 기록"}),t.jsx("p",{className:"text-white/80 text-sm",children:i.dayModeSummary})]}),t.jsxs(te,{className:"flex-1 !bg-black/20 !border-white/10 !rounded-2xl overflow-hidden min-h-card shadow-2xl backdrop-blur-md relative",children:[t.jsx("textarea",{maxLength:F,value:i.diary,onChange:f=>i.updateDiary(f.target.value),placeholder:"오늘 하루를 기록해보세요...",className:"w-full h-full bg-transparent resize-none focus:outline-none text-white placeholder:text-white/20 text-xl leading-relaxed p-4 font-sans",autoFocus:!0,"aria-label":"오늘의 일기 작성","aria-describedby":F-i.diary.length<=F-xe?"char-warning-night":void 0}),F-i.diary.length<=F-xe&&t.jsx("p",{id:"char-warning-night",role:"status","aria-live":"polite",className:`absolute bottom-2 right-4 text-xs ${i.diary.length>=F?"text-red-400":"text-amber-400"}`,children:i.diary.length>=F?"최대 글자 수에 도달했습니다":`${F-i.diary.length}자 남음`})]}),t.jsxs(_,{onClick:A,isLoading:i.isAnalyzing,className:"w-full py-5 bg-gradient-to-r from-purple-600 to-indigo-600 shadow-lg border-none text-lg font-bold rounded-xl","aria-label":"일기 분석 및 편지 생성",children:[t.jsx(J,{className:"w-5 h-5 mr-2"}),"별에게 보내기"]})]},"step-diary"),g==="letter"&&t.jsx(x.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex-1 flex flex-col h-full overflow-hidden pb-10 w-full max-w-3xl mx-auto",children:t.jsxs(te,{className:"h-full flex flex-col !bg-indigo-950/60 !border-white/10 !rounded-2xl !p-8 shadow-2xl backdrop-blur-xl",children:[t.jsxs("div",{className:"flex justify-between items-start mb-8 shrink-0 pb-6 border-b border-white/5",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"w-14 h-14 rounded-full bg-indigo-500/50 flex items-center justify-center shadow-lg border border-white/10",children:t.jsx(J,{size:24,className:"text-purple-200"})}),t.jsxs("div",{children:[t.jsxs("h3",{className:"text-white font-bold text-lg",children:["보낸이. ",e.name]}),t.jsxs("span",{className:"text-indigo-300 text-xs font-medium uppercase tracking-wider",children:["인공지능 ",e.role]})]})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(at,{text:i.letter})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto pr-4 scrollbar-hide",children:t.jsx("div",{className:"prose prose-lg prose-invert prose-p:text-indigo-100 prose-p:leading-loose prose-p:font-light font-sans",children:t.jsx("p",{className:"whitespace-pre-wrap",children:i.letter})})}),t.jsx("div",{className:"pt-6 mt-6 border-t border-white/5 shrink-0",children:t.jsx(_,{variant:"ghost",onClick:i.reset,className:"w-full text-indigo-300 hover:text-white hover:bg-white/5 py-4 text-base","aria-label":"새 기록 시작하기",children:"새 기록 시작하기"})})]})},"step-letter")]}),t.jsx(P,{children:l&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"fixed top-24 left-1/2 -translate-x-1/2 z-popover flex items-center gap-3 px-6 py-3 bg-emerald-500/90 backdrop-blur-xl text-white rounded-full shadow-2xl border border-white/20",children:[t.jsx(je,{size:20}),t.jsx("span",{className:"font-bold text-sm",children:"저장되었습니다"})]})})]})},ei=({isOpen:e,onConsent:s,onSkip:a})=>{const r=he(),[l,n]=o.useState(!1),[c,d]=o.useState(!1),i=o.useRef(null);$e({enabled:e,containerRef:i,initialFocusSelector:'input[type="checkbox"]'}),Le({shouldRestore:!e});const g=async()=>{if(l)try{d(!0),await ae(!0),s()}catch(h){console.error("Failed to save consent:",h),alert("동의 저장 중 오류가 발생했습니다. 다시 시도해주세요.")}finally{d(!1)}},S=async()=>{try{await ae(!1),a()}catch(h){console.error("Failed to save consent skip:",h),a()}};return t.jsx(Fe,{children:t.jsx(P,{children:e&&t.jsxs(t.Fragment,{children:[t.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-consent-backdrop bg-black/50 backdrop-blur-sm",onClick:S}),t.jsx(x.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 z-consent-modal flex items-center justify-center p-4 pointer-events-none",children:t.jsxs("div",{ref:i,className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6 pointer-events-auto",onClick:h=>h.stopPropagation(),children:[t.jsx("div",{className:"flex items-center justify-between mb-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-brand-primary/10 flex items-center justify-center",children:t.jsx(re,{size:24,className:"text-brand-primary"})}),t.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"대화 저장에 동의하시겠습니까?"})]})}),t.jsxs("div",{className:"space-y-4 mb-6",children:[t.jsx("p",{className:"text-sm text-slate-600 leading-relaxed",children:"대화와 일기 원문을 저장하면 더 나은 경험을 제공할 수 있습니다."}),t.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 space-y-3",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"📋 저장 목적"}),t.jsx("p",{className:"text-xs text-slate-600",children:"체크인/리포트/액션 추천, AI 인사이트 생성"})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"⏰ 보관기간"}),t.jsx("p",{className:"text-xs text-slate-600",children:"영구 (삭제 요청 시까지)"})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"🗑️ 삭제 권한"}),t.jsx("p",{className:"text-xs text-slate-600",children:"언제든 개별 메시지/대화/전체 삭제 가능"})]})]}),t.jsxs("div",{className:"flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200",children:[t.jsx("div",{className:"pt-0.5",children:t.jsx(re,{size:16,className:"text-amber-600"})}),t.jsx("p",{className:"text-xs text-amber-800 leading-relaxed",children:"동의 없이도 기본 기능은 사용 가능하나, 대화 저장 기능은 사용할 수 없습니다. 감정 수치와 태그는 동의 없이도 저장됩니다."})]}),t.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[t.jsxs("div",{className:"relative mt-0.5",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:h=>n(h.target.checked),className:"sr-only"}),t.jsx("div",{className:`
                        w-5 h-5 rounded border-2 flex items-center justify-center transition-all
                        ${l?"bg-brand-primary border-brand-primary":"border-slate-300 group-hover:border-brand-primary/50"}
                      `,children:l&&t.jsx(nt,{size:14,className:"text-white",strokeWidth:3})})]}),t.jsx("span",{className:"text-sm text-slate-700 leading-relaxed",children:"위 내용을 확인했으며, 대화 저장에 동의합니다."})]})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(_,{onClick:g,variant:"primary",className:"flex-1",disabled:!l||c,children:c?"저장 중...":"동의하고 시작하기"}),t.jsx(_,{onClick:S,variant:"ghost",className:"px-6",children:"나중에"})]}),t.jsx("div",{className:"mt-4 text-center",children:t.jsx("button",{onClick:()=>{r("/profile/privacy/policy")},className:"text-xs text-slate-500 hover:text-brand-primary transition-colors underline","aria-label":"개인정보 처리방침 자세히 보기",children:"자세히 보기"})})]})})]})})})},li=()=>{const e=he(),{mode:s,persona:a,addTimelineEntry:r}=Pe(),{setIsImmersive:l}=Ge(),[n,c]=o.useState(!1),[d,i]=o.useState(!1);o.useEffect(()=>{(async()=>{if(!d)try{const m=await He();!m.consentedAt&&!m.revokedAt&&c(!0),i(!0)}catch(m){console.error("Error checking consent:",m),i(!0)}})()},[d]);const g=async j=>{try{await fe({emotion:j.emotion,intensity:j.intensity,contextTags:j.nuanceTags,modeAtTime:s}),r(j)}catch(m){Ue("ChatMain.handleSaveEntry",m)}},S=()=>{e("/reports/weekly")},h=()=>{e("/safety?returnTo="+encodeURIComponent("/chat"))},A=()=>{e("/safety?returnTo="+encodeURIComponent("/chat"))},f=()=>{c(!1)},b=()=>{c(!1)};return t.jsxs(t.Fragment,{children:[t.jsx(ei,{isOpen:n,onConsent:f,onSkip:b}),s==="day"?t.jsx(Gt,{persona:a,onSave:g,setImmersive:l,onNavigateToReports:S,onOpenSafety:h,onCrisisDetected:A}):t.jsx(Zt,{persona:a,onSave:g,onCrisisDetected:A})]})};export{li as ChatMain};
