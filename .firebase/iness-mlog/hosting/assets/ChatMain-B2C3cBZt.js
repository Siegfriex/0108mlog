import{j as t,m as x,A as F}from"./framer-motion-BL4N7xFA.js";import{r as o,d as pe}from"./react-vendor-CHpw1G1i.js";import{B as A,E as D,g as Se,a as ue,s as we,b as ye,c as Ee,d as Ce,u as Ae,e as Te,G as Z,f as ve,h as ke,i as Ie,j as _e,k as Re,l as Me,P as De,m as se,n as Oe,o as ze,p as Le,q as $e}from"./index-Dty_Gb9U.js";import{t as Fe,X as ee,r as Pe,n as Ge,P as He,M as xe,C as Ue,g as U,k as Ye,u as Ve,v as Be,w as We,x as Ke,m as he,q as Xe,h as qe,S as fe,c as ge,F as be,d as je,e as Ne,y as Qe,A as Je,z as ne,D as Ze}from"./lucide-react-CKY1Dauo.js";import{V as et}from"./VoicePlayer-Dhrtn4CN.js";import"./firebase-BBl07Gss.js";const tt=({intensity:e="medium"})=>{const n=e==="low"?20:e==="high"?60:40;return t.jsxs("div",{className:"absolute inset-0 pointer-events-none overflow-hidden z-base",children:[Array.from({length:n}).map((a,r)=>{const l=Math.random()*3+1,s=Math.random()*100,u=Math.random()*100,c=Math.random()*2,i=Math.random()*3+2;return t.jsx(x.div,{className:"absolute rounded-full bg-white",style:{width:`${l}px`,height:`${l}px`,left:`${s}%`,top:`${u}%`},animate:{opacity:[.3,1,.3],scale:[1,1.2,1]},transition:{duration:i,repeat:1/0,delay:c,ease:"easeInOut"}},`star-${r}`)}),t.jsx(x.div,{className:"absolute rounded-full blur-xl",style:{width:"200px",height:"200px",background:"radial-gradient(circle, rgba(255,255,255,0.3), transparent)",top:"10%",right:"15%"},animate:{opacity:[.4,.6,.4],scale:[1,1.05,1]},transition:{duration:4,repeat:1/0,ease:"easeInOut"}}),t.jsx(x.div,{className:"absolute w-full h-full",style:{background:"linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.15) 50%, transparent 100%)",top:0,left:0},animate:{opacity:[.3,.5,.3]},transition:{duration:6,repeat:1/0,ease:"easeInOut"}})]})},it=()=>t.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[t.jsxs(x.div,{className:"relative w-8 h-8",animate:{rotate:360},transition:{duration:2,repeat:1/0,ease:"linear"},children:[t.jsx(x.div,{className:"absolute inset-0 rounded-full border-2 border-brand-primary/30",animate:{scale:[1,1.2,1],opacity:[.5,.8,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),t.jsx(x.div,{className:"absolute top-1/2 left-1/2 w-2 h-2 -translate-x-1/2 -translate-y-1/2 bg-brand-primary rounded-full",animate:{scale:[1,1.5,1],opacity:[1,.7,1]},transition:{duration:1,repeat:1/0,ease:"easeInOut"}})]}),t.jsx("div",{className:"flex gap-1",children:[0,1,2].map(e=>t.jsx(x.div,{className:"w-2 h-2 bg-brand-primary rounded-full",animate:{y:[0,-8,0],opacity:[.5,1,.5],scale:[1,1.2,1]},transition:{duration:.8,repeat:1/0,delay:e*.2,ease:"easeInOut"}},e))}),t.jsx(x.span,{className:"text-xs text-slate-500 font-medium",animate:{opacity:[.5,1,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"생각 중..."})]}),st=(e,n)=>{const a=n===0||n===6,r=[];return e>=6&&e<9?r.push("아침","출근 전"):e>=9&&e<12?(r.push("오전","업무"),a||r.push("회의")):e>=12&&e<14?r.push("점심","식사"):e>=14&&e<18?r.push("오후","업무"):e>=18&&e<22?r.push("저녁","퇴근 후"):r.push("밤","휴식"),n===1&&r.push("월요일"),a&&r.push("주말"),r.slice(0,3)},nt=e=>{if(!e)return[];const n=[];return e.placeType==="work"?n.push("회사","업무","동료"):e.placeType==="home"?n.push("집","홈","가족"):n.push("외출","이동"),n.slice(0,3)},at=["출근","퇴근","회의","업무","점심","저녁","아침","밤","주말","휴식","운동","독서","가족","친구","혼자","스트레스","기쁨","평온","불안","슬픔","분노","피곤","에너지","집중"],rt=({onTagsChange:e,initialTags:n=[],locationPermission:a="default"})=>{const[r,l]=o.useState(n),[s,u]=o.useState([]),[c,i]=o.useState(null),[f,S]=o.useState(!1),[h,T]=o.useState("");o.useEffect(()=>{(async()=>{const w=new Date,m=w.getHours(),N=w.getDay(),R=st(m,N);u(R),a==="granted"&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(_=>{const v={latitude:_.coords.latitude,longitude:_.coords.longitude,placeType:m>=9&&m<18&&N>=1&&N<=5?"work":"other"};i(v);const k=nt(v);u(O=>[...O,...k].slice(0,3))},_=>{console.warn("위치 감지 실패:",_)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:6e4})})()},[a]);const g=d=>{if(r.includes(d)){const w=r.filter(m=>m!==d);l(w),e(w)}else if(r.length<3){const w=[...r,d];l(w),e(w)}},b=()=>{if(h.trim()&&r.length<3&&!r.includes(h.trim())){const d=[...r,h.trim()];l(d),e(d),T(""),S(!1)}},j=d=>{const w=r.filter(m=>m!==d);l(w),e(w)};return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-slate-900 text-sm mb-1",children:"상황 태그"}),t.jsx("p",{className:"text-xs text-slate-500",children:"오늘은 어떤 상황이었나요? (선택사항, 최대 3개)"})]}),r.length>0&&t.jsxs("span",{className:"text-xs font-bold text-brand-primary",children:[r.length,"/3"]})]}),r.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:r.map(d=>t.jsxs(x.div,{initial:{scale:0},animate:{scale:1},className:"flex items-center gap-2 px-3 py-1.5 bg-brand-primary text-white rounded-full text-sm font-medium",children:[t.jsx(Fe,{size:14}),t.jsx("span",{children:d}),t.jsx("button",{onClick:()=>j(d),className:"hover:bg-white/20 rounded-full p-0.5 transition-colors","aria-label":`${d} 태그 제거`,children:t.jsx(ee,{size:14})})]},d))}),s.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(Pe,{size:14,className:"text-slate-400"}),t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"추천 태그"}),c&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-slate-300",children:"•"}),t.jsx(Ge,{size:14,className:"text-slate-400"}),t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"위치 기반"})]})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:s.filter(d=>!r.includes(d)).map(d=>t.jsx(x.button,{onClick:()=>g(d),whileHover:{scale:1.05},whileTap:{scale:.95},disabled:r.length>=3,className:`
                    px-3 py-1.5 rounded-full text-sm font-medium
                    transition-all duration-300
                    ${r.length>=3?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-white/80 border border-white/60 text-slate-700 hover:bg-brand-light hover:border-brand-primary/30"}
                  `,children:d},d))})]}),r.length<3&&t.jsx("div",{children:f?t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:h,onChange:d=>T(d.target.value),onKeyPress:d=>d.key==="Enter"&&b(),placeholder:"태그 입력 (최대 10자)",maxLength:10,className:"flex-1 px-3 py-2 rounded-lg bg-white/80 border border-white/60 focus:outline-none focus:ring-2 focus:ring-brand-primary/50 text-sm"}),t.jsx(A,{onClick:b,variant:"primary",disabled:!h.trim(),className:"!px-4 !py-2",children:"추가"}),t.jsx(A,{onClick:()=>{S(!1),T("")},variant:"ghost",className:"!px-4 !py-2",children:"취소"})]}):t.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-2 px-3 py-1.5 text-sm text-slate-500 hover:text-brand-primary transition-colors",children:[t.jsx(He,{size:14}),t.jsx("span",{children:"직접 입력하기"})]})}),r.length<3&&!f&&t.jsxs("details",{className:"text-xs",children:[t.jsx("summary",{className:"cursor-pointer text-slate-400 hover:text-slate-600 mb-2",children:"더 많은 태그 보기"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:at.filter(d=>!r.includes(d)&&!s.includes(d)).slice(0,12).map(d=>t.jsx("button",{onClick:()=>g(d),disabled:r.length>=3,className:`
                    px-2 py-1 rounded-md text-xs
                    transition-all duration-300
                    ${r.length>=3?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-slate-50 text-slate-600 hover:bg-brand-light hover:text-brand-primary"}
                  `,children:d},d))})]})]})},ot=({className:e="",text:n,onClick:a,onCheckIn:r,onWeeklySummary:l,onTodayAction:s,onSafety:u})=>{if(n&&a)return t.jsx(x.button,{onClick:a,whileHover:{scale:1.05},whileTap:{scale:.95},className:`
          flex items-center gap-2 px-4 py-2.5 rounded-full
          bg-white/80 backdrop-blur-sm border border-slate-200/60
          text-slate-700 hover:text-brand-primary hover:border-brand-primary/50
          font-medium text-xs
          whitespace-nowrap
          shadow-sm hover:shadow-md
          transition-all duration-300
          min-w-fit
          h-10
        `,children:t.jsx("span",{children:n})});const c=[{id:"checkin",label:"오늘 체크인",icon:t.jsx(xe,{size:16,strokeWidth:2}),onClick:r,color:"bg-brand-primary"},{id:"summary",label:"이번 주 요약",icon:t.jsx(Ue,{size:16,strokeWidth:2}),onClick:l,color:"bg-brand-secondary"},{id:"action",label:"오늘 1개",icon:t.jsx(U,{size:16,strokeWidth:2}),onClick:s,color:"bg-brand-accent"},{id:"safety",label:"안전 도움",icon:t.jsx(Ye,{size:16,strokeWidth:2}),onClick:u,color:"bg-red-500"}];return t.jsx("div",{className:`flex gap-2 overflow-x-auto scrollbar-hide pb-2 ${e}`,children:c.map(i=>t.jsxs(x.button,{onClick:i.onClick,whileHover:{scale:1.05},whileTap:{scale:.95},className:`
            flex items-center gap-2 px-4 py-2.5 rounded-full
            ${i.color} text-white
            font-bold text-xs
            whitespace-nowrap
            shadow-sm hover:shadow-md
            transition-all duration-300
            min-w-24
            h-12
          `,children:[i.icon,t.jsx("span",{children:i.label})]},i.id))})},lt=({actionTitle:e,onComplete:n,onSkip:a})=>{const[r,l]=o.useState("before"),[s,u]=o.useState(null),[c,i]=o.useState(null),f=j=>{u(j),l("after")},S=j=>{i(j),l("result")},h=()=>{l("after"),i(null)},T=()=>{s!==null&&c!==null&&n(s,c)},b=s===null||c===null?null:c-s;return t.jsx("div",{className:"w-full max-w-md mx-auto space-y-6",children:t.jsxs(F,{mode:"wait",children:[r==="before"&&t.jsxs(x.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2",children:"액션 시작 전"}),t.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"지금 감정 강도는 어느 정도인가요?"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"강도"}),t.jsxs("span",{className:"text-xl font-bold text-brand-primary",children:[s!==null?s:"-","/10"]})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:s||5,onChange:j=>u(Number(j.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-primary"}),t.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[t.jsx("span",{children:"1"}),t.jsx("span",{children:"5"}),t.jsx("span",{children:"10"})]}),t.jsx(A,{onClick:()=>f(s||5),variant:"primary",className:"w-full",children:"다음 단계로"}),a&&t.jsx(A,{onClick:a,variant:"ghost",className:"w-full",children:"스킵"})]})]},"before"),r==="after"&&t.jsxs(x.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2",children:"액션 완료 후"}),t.jsxs("p",{className:"text-sm text-slate-600 mb-6",children:[e,"를 완료한 후 감정 강도는 어느 정도인가요?"]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("span",{className:"text-xs font-medium text-slate-500",children:"강도"}),t.jsxs("span",{className:"text-xl font-bold text-brand-primary",children:[c!==null?c:"-","/10"]})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:c||s||5,onChange:j=>i(Number(j.target.value)),className:"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-primary"}),t.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[t.jsx("span",{children:"1"}),t.jsx("span",{children:"5"}),t.jsx("span",{children:"10"})]}),t.jsx(A,{onClick:()=>S(c||s||5),variant:"primary",className:"w-full",children:"결과 보기"}),t.jsxs(A,{onClick:h,variant:"ghost",className:"w-full",children:[t.jsx(Ve,{size:16,className:"mr-2"}),"5초 후 다시 체크"]})]})]},"after"),r==="result"&&b!==null&&t.jsxs(x.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.05},className:"bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-white/60 shadow-lg",children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-2 text-center",children:"변화 결과"}),t.jsxs("div",{className:"flex items-center justify-center gap-4 my-6",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-3xl font-bold text-slate-700 mb-1",children:s}),t.jsx("div",{className:"text-xs text-slate-500",children:"Before"})]}),t.jsxs("div",{className:`
                flex items-center gap-2 px-4 py-2 rounded-full
                ${b>0?"bg-green-100 text-green-700":b<0?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"}
              `,children:[b>0?t.jsx(Be,{size:24}):b<0?t.jsx(We,{size:24}):t.jsx(Ke,{size:24}),t.jsx("span",{className:"text-xl font-bold",children:b>0?`+${b}`:b})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-3xl font-bold text-slate-700 mb-1",children:c}),t.jsx("div",{className:"text-xs text-slate-500",children:"After"})]})]}),t.jsx("div",{className:"text-center mb-6",children:b>0?t.jsxs("p",{className:"text-sm text-green-700 font-medium",children:["감정 강도가 ",b,"점 상승했어요"]}):b<0?t.jsxs("p",{className:"text-sm text-blue-700 font-medium",children:["감정 강도가 ",Math.abs(b),"점 하락했어요"]}):t.jsx("p",{className:"text-sm text-slate-600 font-medium",children:"감정 강도가 유지되었어요"})}),t.jsxs(A,{onClick:T,variant:"primary",className:"w-full",children:[t.jsx(he,{size:18,className:"mr-2"}),"완료"]})]},"result")]})})},ct={type:"idle"};function dt(e,n){if(n.type==="CRISIS_DETECTED"&&e.type!=="idle"&&e.type!=="completed"&&e.type!=="error")return{type:"crisis_detected",returnState:e};if(e.type==="crisis_detected"&&n.type==="CRISIS_HANDLED")return e.returnState;if(n.type==="RESET")return{type:"idle"};switch(e.type){case"idle":if(n.type==="OPEN_EMOTION_MODAL")return{type:"emotion_modal_open"};break;case"emotion_modal_open":if(n.type==="SELECT_EMOTION")return{type:"emotion_selected",emotion:n.emotion,intensity:5};break;case"emotion_selected":if(n.type==="CHANGE_INTENSITY")return{type:"emotion_selected",emotion:e.emotion,intensity:n.intensity};if(n.type==="SELECT_EMOTION")return{type:"emotion_selected",emotion:n.emotion,intensity:e.intensity};if(n.type==="CONFIRM_EMOTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[],input:""};break;case"chatting":if(n.type==="UPDATE_INPUT")return{...e,input:n.input};if(n.type==="SEND_MESSAGE"){const a={id:Date.now().toString(),role:"user",content:n.message,timestamp:new Date};return{type:"ai_responding",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a]}}if(n.type==="SHOW_TAG_STEP")return{type:"tag_selecting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[]};if(n.type==="REQUEST_SAVE")return{type:"saving",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[],retryCount:0};if(n.type==="GENERATE_ACTION")return{type:"action_loading",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:[]};break;case"ai_responding":if(n.type==="AI_RESPONSE_SUCCESS"){const a={id:(Date.now()+1).toString(),role:"assistant",content:n.response,timestamp:new Date};return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a],input:""}}if(n.type==="AI_RESPONSE_ERROR"){const a={id:(Date.now()+1).toString(),role:"assistant",content:n.error||"연결에 문제가 발생했습니다. 잠시 후 다시 시도해주세요.",timestamp:new Date};return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:[...e.messages,a],input:""}}break;case"tag_selecting":if(n.type==="UPDATE_TAGS")return{...e,tags:n.tags};if(n.type==="REQUEST_SAVE")return{type:"saving",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,retryCount:0};break;case"saving":if(n.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags};if(n.type==="SAVE_RETRY")return{...e,retryCount:n.retryCount};if(n.type==="SAVE_ERROR")return{type:"error",error:n.error};break;case"saved":if(n.type==="GENERATE_ACTION")return{type:"action_loading",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags};if(n.type==="COMPLETE")return{type:"completed"};break;case"action_loading":if(n.type==="ACTION_LOADED")return{type:"action_showing",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,actionId:n.actionId,actionTitle:n.actionTitle,actionDescription:n.actionDescription,actionDuration:n.actionDuration};if(n.type==="ACTION_LOAD_ERROR")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break;case"action_showing":if(n.type==="START_ACTION_FEEDBACK")return{type:"action_feedback",emotion:e.emotion,intensity:e.intensity,messages:e.messages,tags:e.tags,actionId:e.actionId,actionTitle:e.actionTitle};if(n.type==="DISMISS_ACTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break;case"action_feedback":if(n.type==="COMPLETE_ACTION_FEEDBACK")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};if(n.type==="SKIP_ACTION")return{type:"chatting",emotion:e.emotion,intensity:e.intensity,messages:e.messages,input:""};break}return e}function H(e){return"emotion"in e?e.emotion:null}function V(e){return"intensity"in e?e.intensity:5}function B(e){return"messages"in e?e.messages:[]}function ae(e){return"tags"in e?e.tags:[]}function mt(e){return"input"in e?e.input:""}function re(e){return e.type==="action_showing"||e.type==="action_feedback"?{id:e.actionId,title:e.actionTitle,description:"actionDescription"in e?e.actionDescription:"",duration:"actionDuration"in e?e.actionDuration:""}:null}const oe=e=>e.type==="idle",pt=e=>e.type==="emotion_modal_open",ut=e=>e.type==="emotion_selected",yt=e=>e.type==="chatting",xt=e=>e.type==="ai_responding",ht=e=>e.type==="tag_selecting",ft=e=>e.type==="saving",gt=e=>e.type==="saved",bt=e=>e.type==="action_loading",jt=e=>e.type==="action_showing",Nt=e=>e.type==="action_feedback",St=e=>e.type==="completed",wt=e=>e.type==="crisis_detected",Et=e=>e.type==="error",Ct=["자해","자상","칼","약물 과다복용","약물과다복용","약물과다","목매기","손목","약 먹고 싶다","자해하고 싶다","자해하고싶다","자해하고 싶어","자해하고싶어","자해할까","자해할까?","상처","피","아프게","고통","참을 수 없어","죽고 싶다","죽고싶다","죽고 싶어","죽고싶어","죽고 싶어요","죽고싶어요","끝내고 싶다","끝내고싶다","끝내고 싶어","끝내고싶어","더 이상 못 살겠다","더이상 못 살겠다","못 살겠다","못살겠다","생명을 끊고 싶다","생명을 끊고싶다","생명 끊고 싶다","자살하고 싶다","자살하고싶다","자살하고 싶어","자살하고싶어","자살할까","자살할까?","자살 생각","자살생각","죽음","죽을래","죽을래요","죽고 싶어요","끝","끝내고 싶어요","끝내고싶어요","도와줘","도와주세요","구해줘","구해주세요","힘들어","힘들어요","버틸 수 없어","버틸수없어","포기하고 싶어","포기하고싶어","포기할래"],te=[D.ANXIETY,D.SADNESS,D.ANGER];function At(e){if(!e||e.trim().length===0)return{isCrisis:!1,reason:"none",confidence:"low"};const n=e.toLowerCase(),a=n.replace(/\s+/g,""),r=Ct.filter(l=>{const s=l.toLowerCase().replace(/\s+/g,"");return a.includes(s)||n.includes(l.toLowerCase())});return r.length>0?{isCrisis:!0,reason:"keyword",confidence:r.length>=2?"high":"medium",details:`감지된 키워드: ${r.join(", ")}`}:{isCrisis:!1,reason:"none",confidence:"low"}}function Tt(e,n){return te.includes(e)&&n>=9?{isCrisis:!0,reason:"intensity",confidence:n===10?"high":"medium",details:`${e} 감정, 강도 ${n}`}:{isCrisis:!1,reason:"none",confidence:"low"}}function vt(e){if(e.length===0)return{isCrisis:!1,reason:"none",confidence:"low"};const n=e.filter(s=>{const u=te.includes(s.emotion),c=s.intensity>=8;return u&&c}),a=new Set;if(n.forEach(s=>{const u=s.timestamp.toISOString().split("T")[0];a.add(u)}),a.size>=3)return{isCrisis:!0,reason:"pattern",confidence:a.size>=5?"high":"medium",details:`연속 ${a.size}일간 부정적 감정 강도 8 이상`};if(e.length>=2){const s=e[0],u=e[1];if((s.timestamp.getTime()-u.timestamp.getTime())/(1e3*60*60*24)<=1){const f=s.intensity-u.intensity;if(u.intensity<=3&&s.intensity>=9&&f>=6)return{isCrisis:!0,reason:"pattern",confidence:"medium",details:`급격한 감정 변화: 강도 ${u.intensity} → ${s.intensity}`}}}const r=e.filter(s=>{const u=te.includes(s.emotion),c=s.intensity>=7;return u&&c}),l=new Set;return r.forEach(s=>{const u=s.timestamp.toISOString().split("T")[0];l.add(u)}),l.size>=7?{isCrisis:!0,reason:"pattern",confidence:"medium",details:`${l.size}일간 부정적 감정 강도 7 이상 지속`}:{isCrisis:!1,reason:"none",confidence:"low"}}function z(e){const{text:n,emotion:a,intensity:r,recentEntries:l=[]}=e;if(n){const s=At(n);if(s.isCrisis)return s}if(a&&r!==void 0){const s=Tt(a,r);if(s.isCrisis)return s}if(l.length>0){const s=vt(l);if(s.isCrisis)return s}return{isCrisis:!1,reason:"none",confidence:"low"}}const kt=[{id:"MA-001",title:"2분 박스 호흡",description:"4초 들이마시기 → 4초 멈춤 → 4초 내쉬기 → 4초 멈춤. 4번 반복.",duration:"2 min",type:"breathing"},{id:"MA-002",title:"4-6 호흡(긴 내쉬기)",description:"4초 들이마시고 6초 내쉬기. 8번 반복.",duration:"2 min",type:"breathing"},{id:"MA-003",title:"긴 내쉬기 10번",description:'숨을 편하게 들이마신 뒤, 내쉬는 호흡을 "조금 더 길게" 10번.',duration:"2 min",type:"breathing"},{id:"MA-004",title:"5-4-3-2-1 감각 체크",description:"보이는 것 5개, 만져지는 것 4개, 들리는 것 3개, 냄새 2개, 맛 1개를 조용히 확인.",duration:"3 min",type:"breathing"},{id:"MA-005",title:"손을 가슴에(자기 체크)",description:'한 손을 가슴에 두고 "지금 이 순간"에 집중하며 호흡 10번.',duration:"2 min",type:"breathing"},{id:"MA-006",title:"1분 바디 스캔 + 1분 호흡",description:"머리→어깨→가슴→배→다리 순서로 긴장 부위를 찾고, 마지막 1분은 호흡만.",duration:"2 min",type:"breathing"},{id:"MA-007",title:"3문장 마음 정리",description:'"지금 느끼는 감정은 ___.", "몸은 ___.", "다음에 필요한 건 ___." 3문장만 작성.',duration:"3 min",type:"breathing"},{id:"MA-008",title:"어깨/목 풀기(3분)",description:"어깨를 10번 돌리고, 목을 좌/우 천천히 10초씩. 마지막에 깊게 기지개.",duration:"3 min",type:"exercise"},{id:"MA-009",title:"3분 걷기",description:"집/사무실에서라도 3분만 천천히 걷기. 걸으며 발바닥 감각에 집중.",duration:"3 min",type:"exercise"},{id:"MA-010",title:"전신 기지개 2분",description:"팔을 머리 위로 올려 10초 유지 → 옆구리 늘리기 좌/우 → 몸통 비틀기.",duration:"2 min",type:"exercise"},{id:"MA-011",title:"손목/등 스트레칭",description:"손목을 가볍게 풀고, 등(견갑)을 30초씩 늘리기.",duration:"2 min",type:"exercise"},{id:"MA-012",title:"제자리 걷기(4분)",description:"1분 제자리 걷기 + 30초 쉬기 × 2세트. 숨이 너무 차지 않게.",duration:"4 min",type:"exercise"},{id:"MA-013",title:"물 한 잔 + 자세 리셋",description:"물 한 잔 마시고, 의자에 앉아 골반/등/목을 곧게 30초 유지.",duration:"3 min",type:"exercise"},{id:"MA-014",title:"감정 이름 붙이기",description:'"나는 지금 ___을 느낀다" 한 줄 + 이유(한 줄)만.',duration:"2 min",type:"journaling"},{id:"MA-015",title:"오늘 잘한 것 1개",description:'오늘 내가 한 "작은 성공" 1가지만 적기.',duration:"2 min",type:"journaling"},{id:"MA-016",title:"감사 1줄",description:"감사한 것 1개를 1줄로 적기(사람/상황/나 자신).",duration:"2 min",type:"journaling"},{id:"MA-017",title:'다음 "가장 작은 한 걸음"',description:'지금 해야 할 일/목표가 있다면 "5분 안에 가능한 1단계"를 적고, 시작 버튼만 누르기(실행은 선택).',duration:"3 min",type:"journaling"},{id:"MA-018",title:"머릿속 비우기 3줄",description:'떠오르는 생각을 3줄로 적고, 마지막 줄에 "지금은 여기까지"라고 마무리.',duration:"3 min",type:"journaling"},{id:"MA-019",title:"걱정 타임박스",description:'걱정을 2분 동안 적고, 마지막 1분은 "다음에 할 수 있는 1개"만 적기.',duration:"3 min",type:"journaling"},{id:"MA-020",title:"오늘의 우선순위 1개",description:"오늘 가장 중요한 것 1개만 정하고, 나머지는 잠시 내려놓기.",duration:"2 min",type:"journaling"},{id:"MA-021",title:"하루 마무리 한 줄",description:'"오늘의 나에게 한 줄"을 쓰기.',duration:"2 min",type:"journaling"},{id:"MA-022",title:"고마움 메시지 1개",description:'고마운 사람에게 짧게 "고마웠어" 한 문장 보내기(길게 X).',duration:"2 min",type:"mindfulness"},{id:"MA-023",title:"나에게 응원 한 줄",description:'"나는 지금도 충분히 하고 있어"처럼 나에게 한 문장.',duration:"2 min",type:"mindfulness"},{id:"MA-024",title:"안부 한 줄(가벼운 연결)",description:"부담 없는 안부 1줄 보내기(답을 기대하지 않기).",duration:"3 min",type:"mindfulness"},{id:"MA-025",title:"미소/표정 풀기",description:"턱/미간 힘을 풀고, 어깨를 내리며 10초 미소.",duration:"2 min",type:"mindfulness"},{id:"MA-026",title:"책상 위 2분 정리",description:'눈에 보이는 3가지만 제자리로. 끝나면 "완료"만 누르기.',duration:"2 min",type:"mindfulness"},{id:"MA-027",title:"창문 열기 + 공기 바꾸기",description:"창문을 열고 10번 천천히 호흡. 창문이 없다면 자리에서 몸을 펴기.",duration:"2 min",type:"mindfulness"},{id:"MA-028",title:"빛/소리 세팅",description:"화면 밝기/조명 조정, 불필요한 알림 끄기(10분만).",duration:"3 min",type:"mindfulness"},{id:"MA-029",title:"내일을 위한 1분 준비",description:"내일의 첫 할 일 1개를 적고(1분), 필요한 것 1가지만 꺼내두기(2분).",duration:"3 min",type:"journaling"},{id:"MA-030",title:"좋아하는 음악 1곡",description:"좋아하는 음악 1곡을 들으며 호흡/몸 감각만 느끼기.",duration:"3 min",type:"mindfulness"}],L=e=>kt.filter(n=>n.type===e),It=e=>e>=8?L("breathing").slice(0,3):e>=5?[...L("breathing").slice(0,2),...L("exercise").slice(0,2)]:[...L("journaling").slice(0,2),...L("mindfulness").slice(0,2)],_t=(e,n)=>{const a=It(n);return e==="JOY"||e==="PEACE"?[...L("mindfulness").slice(0,2),...L("journaling").slice(0,2),...a.slice(0,1)]:e==="ANXIETY"||e==="SADNESS"?[...L("journaling").slice(0,2),...L("mindfulness").slice(0,2),...a.slice(0,1)]:a};function Rt(e){const{persona:n,onCrisisDetected:a,onComplete:r,onEmotionChange:l}=e,[s,u]=o.useReducer(dt,ct),c=o.useRef(null),i=o.useCallback(p=>{u(p)},[]),f=o.useCallback(()=>{i({type:"OPEN_EMOTION_MODAL"})},[i]),S=o.useCallback(async p=>{i({type:"SELECT_EMOTION",emotion:p}),l==null||l(p);const E=V(s);z({emotion:p,intensity:E}).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,s,a,l]),h=o.useCallback(async p=>{i({type:"CHANGE_INTENSITY",intensity:p});const E=H(s);E&&z({emotion:E,intensity:p}).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,s,a]),T=o.useCallback(()=>{i({type:"CONFIRM_EMOTION"}),l==null||l(H(s))},[i,s,l]),g=o.useCallback(p=>{i({type:"UPDATE_INPUT",input:p})},[i]),b=o.useCallback(async p=>{if(!p.trim())return;if(z({text:p}).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"SEND_MESSAGE",message:p});const M=B(s).map(C=>`${C.role==="user"?"사용자":n.name}: ${C.content}`);try{const C=await Se(p,M,n);i({type:"AI_RESPONSE_SUCCESS",response:C})}catch(C){const P=C instanceof Error?C.message:"연결에 문제가 발생했습니다.";i({type:"AI_RESPONSE_ERROR",error:P})}},[i,s,n,a]),j=o.useCallback(()=>{i({type:"SHOW_TAG_STEP"})},[i]),d=o.useCallback(p=>{i({type:"UPDATE_TAGS",tags:p})},[i]),w=o.useCallback(async()=>{const p=H(s),E=V(s),I=B(s),M=ae(s);if(!p)return;const C=I.map($=>`[${$.role==="user"?"나":n.name}]: ${$.content}`).join(`

`),P=await ue(7);if(z({text:C,emotion:p,intensity:E,recentEntries:P}).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"REQUEST_SAVE"});let G=0;const ie=3;for(;G<=ie;)try{const $=I.length>0?I[0].content.slice(0,30):"체크인",q=await we({title:$,messages:I.map(Y=>({role:Y.role,content:Y.content})),emotion:p,intensity:E,modeAtTime:"day",contextTags:M.length>0?M:void 0});await ye({emotion:p,intensity:E,modeAtTime:"day",contextTags:M.length>0?M:void 0,conversationId:q||void 0}),i({type:"SAVE_SUCCESS"});const Q={id:Date.now().toString(),date:new Date,type:"day",emotion:p,intensity:E,summary:$,detail:C,nuanceTags:M};r==null||r(Q);return}catch($){G++;const q=$ instanceof Error?$.message:"저장 실패";if(G<=ie){const Q=Math.pow(2,G-1)*1e3;await new Promise(Y=>setTimeout(Y,Q)),i({type:"SAVE_RETRY",retryCount:G})}else i({type:"SAVE_ERROR",error:q})}},[s,i,n,a,r]),m=o.useCallback(async()=>{const p=H(s),E=V(s),I=B(s);if(p){i({type:"GENERATE_ACTION"});try{const M=_t(p,E);let C;M.length>0?C=M[0]:C=await Ee(p,E,I.map(P=>P.content).join(" ")),i({type:"ACTION_LOADED",actionId:C.id,actionTitle:C.title,actionDescription:C.description,actionDuration:C.duration})}catch{i({type:"ACTION_LOAD_ERROR"})}}},[s,i]),N=o.useCallback(()=>{i({type:"START_ACTION_FEEDBACK"})},[i]),R=o.useCallback(async(p,E)=>{const I=re(s);if(I)try{await Ce({actionId:I.id,actionTitle:I.title,beforeIntensity:p,afterIntensity:E,completed:!0,skipped:!1})}catch(M){console.error("Error saving micro action log:",M)}i({type:"COMPLETE_ACTION_FEEDBACK",before:p,after:E})},[s,i]),_=o.useCallback(()=>{i({type:"SKIP_ACTION"})},[i]),v=o.useCallback(()=>{i({type:"DISMISS_ACTION"})},[i]),k=o.useCallback(()=>{i({type:"CRISIS_HANDLED"})},[i]),O=o.useCallback(()=>{i({type:"COMPLETE"})},[i]),y=o.useCallback(()=>{c.current&&(clearTimeout(c.current),c.current=null),i({type:"RESET"})},[i]);return o.useEffect(()=>()=>{c.current&&clearTimeout(c.current)},[]),o.useEffect(()=>{oe(s)&&f()},[]),{state:s,isIdle:oe(s),isEmotionModalOpen:pt(s),isEmotionSelected:ut(s),isChatting:yt(s),isAIResponding:xt(s),isTagSelecting:ht(s),isSaving:ft(s),isSaved:gt(s),isActionLoading:bt(s),isActionShowing:jt(s),isActionFeedback:Nt(s),isCompleted:St(s),isCrisisDetected:wt(s),isError:Et(s),emotion:H(s),intensity:V(s),messages:B(s),tags:ae(s),input:mt(s),action:re(s),openEmotionModal:f,selectEmotion:S,changeIntensity:h,confirmEmotion:T,updateInput:g,sendMessage:b,showTagStep:j,updateTags:d,requestSave:w,generateAction:m,startActionFeedback:N,completeActionFeedback:R,skipAction:_,dismissAction:v,handleCrisisHandled:k,complete:O,reset:y}}const Mt=[{id:D.JOY,label:"완전 최고",icon:t.jsx(fe,{size:36,strokeWidth:2}),color:"text-amber-500",bgGradient:"from-amber-200/40 via-yellow-100/40 to-orange-100/40"},{id:D.PEACE,label:"괜찮아요",icon:t.jsx(ge,{size:36,strokeWidth:2}),color:"text-brand-primary",bgGradient:"from-brand-secondary/40 via-teal-100/40 to-cyan-100/40"},{id:D.ANXIETY,label:"조금 불안해요",icon:t.jsx(be,{size:36,strokeWidth:2}),color:"text-orange-500",bgGradient:"from-orange-200/40 via-red-100/40 to-amber-100/40"},{id:D.SADNESS,label:"우울해요",icon:t.jsx(je,{size:36,strokeWidth:2}),color:"text-indigo-500",bgGradient:"from-indigo-200/40 via-purple-100/40 to-slate-100/40"},{id:D.ANGER,label:"화가 나요",icon:t.jsx(Ne,{size:36,strokeWidth:2}),color:"text-rose-500",bgGradient:"from-rose-200/40 via-red-100/40 to-orange-100/40"}],Dt=[{id:"1",text:"오늘 하루는 어땠어요?",emotion:null},{id:"2",text:"무엇이 기분에 영향을 줬나요?",emotion:null},{id:"3",text:"지금 가장 필요한 건 뭐예요?",emotion:null}],Ot=({persona:e,onSave:n,setImmersive:a,onNavigateToReports:r,onOpenSafety:l,onCrisisDetected:s,onEmotionChange:u})=>{const{triggerHaptic:c}=Ae(),i=Rt({persona:e,onCrisisDetected:s,onComplete:n,onEmotionChange:u}),f=o.useRef(null),S=o.useRef(null),h=Mt.find(y=>y.id===i.emotion),T=()=>{var y;(y=f.current)==null||y.scrollIntoView({behavior:"smooth"})};o.useEffect(T,[i.messages,i.isAIResponding]),o.useEffect(()=>()=>{a(!1)},[a]);const g=()=>{i.confirmEmotion(),c("medium")},b=y=>{i.selectEmotion(y),c("medium")},j=y=>{i.changeIntensity(y),c("light")},d=y=>{var p;i.updateInput(y),(p=S.current)==null||p.focus(),c("light")},w=async()=>{i.input.trim()&&(c("light"),await i.sendMessage(i.input))},m=async()=>{if(!(i.isSaved||i.isActionLoading)){if(!i.isTagSelecting&&i.tags.length===0){i.showTagStep();return}a(!1),await i.requestSave()}},N=async()=>{i.emotion&&await i.generateAction()},R=async(y,p)=>{await i.completeActionFeedback(y,p)},_=i.isEmotionModalOpen||i.isEmotionSelected,v=i.isChatting||i.isAIResponding||i.isTagSelecting||i.isSaving||i.isSaved||i.isActionLoading||i.isActionShowing||i.isActionFeedback,k=i.isChatting&&i.messages.length>0&&!i.isAIResponding,O=v&&i.messages.length===0?[{id:"greeting",role:"assistant",content:`안녕하세요! ${e.name}입니다. ${h==null?void 0:h.label} 기분이시군요. 어떤 이야기를 나눠볼까요?`,timestamp:new Date}]:i.messages;return t.jsxs(t.Fragment,{children:[t.jsx(Te,{isOpen:_,selectedEmotion:i.emotion,intensity:i.intensity,onEmotionSelect:b,onIntensityChange:j,onComplete:g}),t.jsx(F,{children:v&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.5,ease:[.16,1,.3,1]},className:"flex flex-col h-full w-full",children:[t.jsxs(x.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},className:"flex items-center justify-between p-4 sm:p-6 border-b border-slate-200/50 bg-white/30 backdrop-blur-md",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[h&&t.jsx(x.div,{className:`${h.color} p-2 rounded-xl bg-white/60 backdrop-blur-sm shadow-sm`,whileHover:{scale:1.05},whileTap:{scale:.95},children:h.icon}),t.jsxs("div",{children:[t.jsx("h2",{className:"font-bold text-lg text-slate-800",children:(h==null?void 0:h.label)||"감정 체크인"}),t.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Xe,{size:12,className:"text-rose-400 fill-rose-400"}),t.jsxs("span",{className:"text-xs text-slate-500",children:["강도: ",i.intensity,"/10"]})]}),t.jsx("span",{className:"text-xs text-slate-400",children:"•"}),t.jsx("span",{className:"text-xs text-slate-500",children:e.name})]})]})]}),t.jsx("button",{onClick:()=>a(!1),className:"p-2 rounded-full hover:bg-white/60 transition-colors text-slate-600","aria-label":"닫기",children:t.jsx(ee,{size:20})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 scrollbar-hide min-h-0",children:[O.map((y,p)=>t.jsx(x.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:p*.05},className:`flex ${y.role==="user"?"justify-end":"justify-start"}`,children:t.jsxs(x.div,{className:`
                      max-w-chat-bubble sm:max-w-chat-bubble-sm rounded-lg px-4 py-3 shadow-sm
                      ${y.role==="user"?"bg-gradient-to-br from-brand-primary to-brand-secondary text-white shadow-brand-primary/20":"bg-white/80 backdrop-blur-md text-slate-900 border border-white/60 shadow-slate-200/50"}
                    `,whileHover:{scale:1.02},transition:{type:"spring",stiffness:400,damping:17},children:[y.role==="assistant"&&t.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[t.jsx("div",{className:"w-5 h-5 rounded-full bg-gradient-to-br from-brand-primary to-brand-secondary flex items-center justify-center",children:t.jsx(xe,{size:12,className:"text-white"})}),t.jsx("span",{className:"text-xs font-semibold text-brand-primary",children:e.name})]}),t.jsx("p",{className:`text-sm leading-relaxed ${y.role==="user"?"text-white":"text-slate-800"}`,children:y.content})]})},y.id)),i.isAIResponding&&t.jsx(x.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex justify-start",children:t.jsx("div",{className:"bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-white/60 p-3",children:t.jsx(it,{})})}),t.jsx("div",{ref:f})]}),t.jsx(F,{children:k&&t.jsx(x.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"px-4 sm:px-6 pb-2",children:t.jsx("div",{className:"flex gap-2 overflow-x-auto scrollbar-hide pb-2",children:Dt.map(y=>t.jsx(ot,{text:y.text,onClick:()=>d(y.text)},y.id))})})}),t.jsxs(F,{children:[i.isActionShowing&&i.action&&t.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"p-4 sm:p-6 border-t border-slate-200/50 bg-white/30 backdrop-blur-md",children:t.jsxs(Z,{className:"p-4",children:[t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(U,{size:18,className:"text-brand-primary"}),t.jsx("h3",{className:"font-bold text-lg text-slate-800",children:"오늘의 작은 실천"})]}),t.jsx("p",{className:"text-sm text-slate-600 leading-relaxed",children:i.action.description})]}),t.jsx("button",{onClick:i.dismissAction,className:"p-1 rounded-full hover:bg-slate-100 transition-colors text-slate-400","aria-label":"액션 카드 닫기",children:t.jsx(ee,{size:18})})]}),t.jsxs(A,{variant:"primary",className:"w-full",onClick:i.startActionFeedback,"aria-label":`${i.action.title} 시도해보기`,children:["시도해보기 (",i.action.duration,")"]})]})}),i.isActionFeedback&&i.action&&t.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"p-4 sm:p-6 border-t border-slate-200/50 bg-white/30 backdrop-blur-md",children:t.jsx(lt,{actionTitle:i.action.title,onComplete:R,onSkip:i.skipAction})})]}),i.isTagSelecting&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4 sm:p-6 border-t border-slate-200/50 bg-white/40 backdrop-blur-md",children:[t.jsx(rt,{onTagsChange:i.updateTags,initialTags:i.tags,locationPermission:"granted"}),t.jsxs("div",{className:"flex gap-2 mt-4",children:[t.jsx(A,{onClick:m,variant:"primary",className:"flex-1","aria-label":"체크인 완료 및 저장",children:"저장하기"}),t.jsx(A,{onClick:m,variant:"ghost",children:"스킵"})]})]}),i.isChatting&&!i.isTagSelecting&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4 sm:p-6 border-t border-slate-200/50 bg-white/40 backdrop-blur-md",children:[t.jsx("div",{className:"flex gap-2 mb-3",children:t.jsxs("div",{className:"flex-1 relative",children:[t.jsx("input",{ref:S,type:"text",value:i.input,onChange:y=>i.updateInput(y.target.value),onKeyPress:y=>y.key==="Enter"&&!y.shiftKey&&w(),placeholder:"무엇이든 편하게 말씀해주세요...",className:"w-full px-4 py-3 pr-12 rounded-full bg-white/80 backdrop-blur-sm border border-slate-200/60 focus:outline-none focus:ring-2 focus:ring-brand-primary/50 focus:border-brand-primary/50 text-slate-800 placeholder-slate-400 transition-all","aria-label":"메시지 입력"}),t.jsx("button",{onClick:w,disabled:!i.input.trim(),className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-brand-primary text-white hover:bg-brand-secondary disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm hover:shadow-md","aria-label":"전송",children:t.jsx(qe,{size:16})})]})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(A,{onClick:m,variant:"secondary",className:"flex-1",disabled:i.isSaved,"aria-label":"체크인 완료 및 저장",children:i.isSaved?"저장 완료 ✓":"대화 마무리"}),t.jsx(A,{onClick:N,variant:"ghost",isLoading:i.isActionLoading,className:"px-4","aria-label":"마이크로 액션 생성",title:"오늘의 작은 실천 추천받기",children:t.jsx(U,{size:18,className:i.isActionLoading?"animate-pulse":""})})]})]})]})})]})},zt={type:"idle"};function Lt(e,n){if(n.type==="CRISIS_DETECTED"&&e.type!=="idle"&&e.type!=="saved"&&e.type!=="error")return{type:"crisis_detected",returnState:e};if(e.type==="crisis_detected"&&n.type==="CRISIS_HANDLED")return e.returnState;if(n.type==="RESET")return{type:"idle"};switch(e.type){case"idle":if(n.type==="START")return{type:"emotion_step",emotion:null,intensity:5};break;case"emotion_step":if(n.type==="SELECT_EMOTION")return{type:"emotion_step",emotion:n.emotion,intensity:e.intensity};if(n.type==="CHANGE_INTENSITY")return{type:"emotion_step",emotion:e.emotion,intensity:n.intensity};if(n.type==="NEXT_TO_DIARY"&&e.emotion)return{type:"diary_step",emotion:e.emotion,intensity:e.intensity,diary:"",dayModeSummary:n.dayModeSummary};break;case"diary_step":if(n.type==="UPDATE_DIARY")return{...e,diary:n.diary};if(n.type==="ANALYZE_DIARY")return{type:"analyzing",emotion:e.emotion,intensity:e.intensity,diary:e.diary,dayModeSummary:e.dayModeSummary};break;case"analyzing":if(n.type==="LETTER_SUCCESS")return{type:"letter_step",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:n.letter,dayModeSummary:e.dayModeSummary};if(n.type==="LETTER_ERROR")return{type:"letter_step",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:"오늘 하루도 수고하셨어요. 내일도 함께 걸어가요.",dayModeSummary:e.dayModeSummary};break;case"letter_step":if(n.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary};if(n.type==="SAVE_RETRY")return{type:"saving",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary,retryCount:n.retryCount};if(n.type==="SAVE_ERROR")return{type:"error",error:n.error};break;case"saving":if(n.type==="SAVE_SUCCESS")return{type:"saved",emotion:e.emotion,intensity:e.intensity,diary:e.diary,letter:e.letter,dayModeSummary:e.dayModeSummary};if(n.type==="SAVE_RETRY")return{...e,retryCount:n.retryCount};if(n.type==="SAVE_ERROR")return{type:"error",error:n.error};break;case"saved":if(n.type==="RESET")return{type:"idle"};break}return e}function W(e){return"emotion"in e?e.emotion:null}function K(e){return"intensity"in e?e.intensity:5}function J(e){return"diary"in e?e.diary:""}function le(e){return"letter"in e?e.letter:""}function ce(e){if("dayModeSummary"in e)return e.dayModeSummary}const de=e=>e.type==="idle",$t=e=>e.type==="emotion_step",Ft=e=>e.type==="diary_step",Pt=e=>e.type==="analyzing",me=e=>e.type==="letter_step",Gt=e=>e.type==="saving",Ht=e=>e.type==="saved",Ut=e=>e.type==="crisis_detected",Yt=e=>e.type==="error";function Vt(e){switch(e.type){case"idle":case"emotion_step":case"crisis_detected":return"emotion";case"diary_step":case"analyzing":return"diary";case"letter_step":case"saving":case"saved":case"error":return"letter";default:return"emotion"}}function Bt(e){const{persona:n,onCrisisDetected:a,onComplete:r,onEmotionChange:l}=e,[s,u]=o.useReducer(Lt,zt),c=o.useRef(!1),i=o.useCallback(m=>{u(m)},[]),f=o.useCallback(()=>{i({type:"START"})},[i]),S=o.useCallback(async m=>{i({type:"SELECT_EMOTION",emotion:m}),l==null||l(m);const N=K(s);z({emotion:m,intensity:N}).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,s,a,l]),h=o.useCallback(async m=>{i({type:"CHANGE_INTENSITY",intensity:m});const N=W(s);N&&z({emotion:N,intensity:m}).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,s,a]),T=o.useCallback(async()=>{let m;try{m=await ve()??void 0}catch(N){console.warn("Day Mode 요약 조회 실패:",N)}i({type:"NEXT_TO_DIARY",dayModeSummary:m})},[i]),g=o.useCallback(async m=>{i({type:"UPDATE_DIARY",diary:m}),m.length>10&&z({text:m}).isCrisis&&(i({type:"CRISIS_DETECTED"}),a==null||a())},[i,a]),b=o.useCallback(async()=>{const m=J(s),N=W(s),R=K(s);if(!m.trim()||!N)return;if(z({text:m}).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}i({type:"ANALYZE_DIARY"});try{const v=await ke(m,n);i({type:"LETTER_SUCCESS",letter:v});const k=await ue(7);if(z({text:m,emotion:N,intensity:R,recentEntries:k}).isCrisis){i({type:"CRISIS_DETECTED"}),a==null||a();return}await j(v)}catch(v){const k=v instanceof Error?v.message:"편지 생성 실패";i({type:"LETTER_ERROR",error:k})}},[s,n,i,a]),j=o.useCallback(async m=>{if(c.current)return;const N=W(s),R=K(s),_=J(s),v=ce(s);if(!N)return;let k=0;const O=3;for(;k<=O;)try{await Ie({content:_,emotion:N,intensity:R,letterContent:m,dayModeSummary:v}),c.current=!0,i({type:"SAVE_SUCCESS"});const y={id:Date.now().toString(),date:new Date,type:"night",emotion:N,intensity:R,summary:_.slice(0,40)+(_.length>40?"...":""),detail:`[감정]: ${N} (강도: ${R})
[나의 일기]
${_}

[${n.name}의 답장]
${m}`};r==null||r(y);return}catch(y){k++;const p=y instanceof Error?y.message:"저장 실패";if(k<=O){const E=Math.pow(2,k-1)*1e3;await new Promise(I=>setTimeout(I,E)),i({type:"SAVE_RETRY",retryCount:k})}else i({type:"SAVE_ERROR",error:p})}},[s,n,i,r]),d=o.useCallback(()=>{i({type:"CRISIS_HANDLED"})},[i]),w=o.useCallback(()=>{c.current=!1,i({type:"RESET"})},[i]);return o.useEffect(()=>{de(s)&&f()},[]),o.useEffect(()=>{if(me(s)&&!c.current){const m=le(s);m&&j(m)}},[s.type]),{state:s,currentStep:Vt(s),isIdle:de(s),isEmotionStep:$t(s),isDiaryStep:Ft(s),isAnalyzing:Pt(s),isLetterStep:me(s),isSaving:Gt(s),isSaved:Ht(s),isCrisisDetected:Ut(s),isError:Yt(s),emotion:W(s),intensity:K(s),diary:J(s),letter:le(s),dayModeSummary:ce(s),start:f,selectEmotion:S,changeIntensity:h,nextToDiary:T,updateDiary:g,analyzeDiary:b,handleCrisisHandled:d,reset:w}}const X=[{id:D.JOY,label:"기쁨",icon:t.jsx(fe,{size:40,strokeWidth:1.5}),color:"joy"},{id:D.PEACE,label:"평온",icon:t.jsx(ge,{size:40,strokeWidth:1.5}),color:"peace"},{id:D.ANXIETY,label:"불안",icon:t.jsx(be,{size:40,strokeWidth:1.5}),color:"anxiety"},{id:D.SADNESS,label:"슬픔",icon:t.jsx(je,{size:40,strokeWidth:1.5}),color:"sadness"},{id:D.ANGER,label:"분노",icon:t.jsx(Ne,{size:40,strokeWidth:1.5}),color:"anger"}],Wt=({persona:e,onSave:n,onCrisisDetected:a,onEmotionChange:r})=>{const[l,s]=o.useState(!1),[u,c]=o.useState(0),i=Bt({persona:e,onCrisisDetected:a,onComplete:g=>{n(g),s(!0),setTimeout(()=>s(!1),3e3)},onEmotionChange:r}),f=i.currentStep;o.useEffect(()=>{if(i.emotion){const g=X.findIndex(b=>b.id===i.emotion);g!==-1&&c(g)}},[i.emotion]);const{containerRef:S}=_e({itemCount:X.length,selectedIndex:u,onSelectChange:c,onEnter:g=>{i.selectEmotion(X[g].id)},enabled:f==="emotion",columns:2,loop:!0,horizontal:!0,vertical:!0}),h=async()=>{f==="emotion"&&i.emotion&&await i.nextToDiary()},T=async()=>{i.diary.trim()&&await i.analyzeDiary()};return t.jsxs("div",{className:"w-full max-w-4xl mx-auto h-full flex flex-col px-4 text-white relative overflow-hidden",children:[t.jsx(tt,{intensity:"medium"}),t.jsxs("div",{className:"py-6 shrink-0 text-center",children:[t.jsxs("h2",{className:"text-2xl font-serif font-bold flex items-center justify-center gap-2 mb-2 drop-shadow-md",children:[t.jsx("span",{className:"text-purple-300",children:t.jsx(Qe,{size:20,fill:"currentColor"})}),f==="emotion"?"저녁 성찰":f==="diary"?"나의 이야기":"당신을 위한 편지"]}),t.jsx("p",{className:"text-white/60 text-sm font-medium",children:f==="emotion"?"오늘 하루 기분은 어떠셨나요?":f==="diary"?"모두 털어놓으세요. 밤이 듣고 있어요.":`${e.name}의 메시지`})]}),t.jsxs(F,{mode:"wait",children:[f==="emotion"&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"flex-1 flex flex-col justify-center items-center gap-8 max-w-2xl mx-auto w-full",children:[t.jsx("div",{ref:S,className:"grid grid-cols-2 md:grid-cols-3 gap-6 w-full",tabIndex:-1,children:X.map((g,b)=>{const j=i.emotion===g.id,d=u===b;return t.jsxs("button",{onClick:()=>{c(b),i.selectEmotion(g.id)},className:`
                                    aspect-square p-6 rounded-lg backdrop-blur-md border text-left transition-all duration-300 flex flex-col justify-center items-center gap-4 group
                                    focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-2 focus:ring-offset-transparent
                                    ${j?"bg-white/20 border-white/60 shadow-glow-white scale-105 ring-1 ring-white/50":"bg-white/5 border-white/5 hover:bg-white/10"}
                                    ${d&&!j?"ring-2 ring-white/30 ring-offset-2 ring-offset-transparent":""}
                                `,tabIndex:d?0:-1,children:[t.jsx("span",{className:"text-white/80 group-hover:scale-110 transition-transform duration-300",children:g.icon}),t.jsx("span",{className:"text-white/90 font-medium text-lg tracking-wide",children:g.label})]},g.id)})}),i.emotion&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white/5 backdrop-blur-xl rounded-lg p-8 border border-white/10 w-full",children:[t.jsxs("div",{className:"flex justify-between text-white font-bold mb-6",children:[t.jsx("span",{className:"text-xs uppercase tracking-wider text-purple-200",children:"감정 깊이"}),t.jsx("span",{className:"text-xl",children:i.intensity})]}),t.jsx("input",{type:"range",min:"1",max:"10",value:i.intensity,onChange:g=>i.changeIntensity(Number(g.target.value)),className:"w-full h-2 bg-white/20 rounded-full appearance-none cursor-pointer accent-purple-300"}),t.jsxs(A,{onClick:h,className:"w-full mt-8 py-4 bg-purple-500 hover:bg-purple-600 border-none text-white font-bold text-lg shadow-xl shadow-purple-900/40","aria-label":"다음 단계로 계속하기",children:["계속하기 ",t.jsx(Je,{size:20})]})]})]},"step-emotion"),f==="diary"&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"flex-1 flex flex-col gap-6 w-full max-w-3xl mx-auto pb-10",children:[i.dayModeSummary&&t.jsxs(x.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-purple-500/20 backdrop-blur-md rounded-lg p-4 border border-purple-300/20",children:[t.jsx("p",{className:"text-purple-200 text-sm font-medium mb-1",children:"오늘 낮의 기록"}),t.jsx("p",{className:"text-white/80 text-sm",children:i.dayModeSummary})]}),t.jsx(Z,{className:"flex-1 !bg-black/20 !border-white/10 !rounded-2xl overflow-hidden min-h-card shadow-2xl backdrop-blur-md",children:t.jsx("textarea",{value:i.diary,onChange:g=>i.updateDiary(g.target.value),placeholder:"오늘 하루를 기록해보세요...",className:"w-full h-full bg-transparent resize-none focus:outline-none text-white placeholder:text-white/20 text-xl leading-relaxed p-4 font-serif",autoFocus:!0})}),t.jsxs(A,{onClick:T,isLoading:i.isAnalyzing,className:"w-full py-5 bg-gradient-to-r from-purple-600 to-indigo-600 shadow-lg border-none text-lg font-bold rounded-xl","aria-label":"일기 분석 및 편지 생성",children:[t.jsx(U,{className:"w-5 h-5 mr-2"}),"별에게 보내기"]})]},"step-diary"),f==="letter"&&t.jsx(x.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex-1 flex flex-col h-full overflow-hidden pb-10 w-full max-w-3xl mx-auto",children:t.jsxs(Z,{className:"h-full flex flex-col !bg-indigo-950/60 !border-white/10 !rounded-2xl !p-8 shadow-2xl backdrop-blur-xl",children:[t.jsxs("div",{className:"flex justify-between items-start mb-8 shrink-0 pb-6 border-b border-white/5",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"w-14 h-14 rounded-full bg-indigo-500/50 flex items-center justify-center shadow-lg border border-white/10",children:t.jsx(U,{size:24,className:"text-purple-200"})}),t.jsxs("div",{children:[t.jsxs("h3",{className:"text-white font-bold text-lg",children:["보낸이. ",e.name]}),t.jsxs("span",{className:"text-indigo-300 text-xs font-medium uppercase tracking-wider",children:["인공지능 ",e.role]})]})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(et,{text:i.letter})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto pr-4 scrollbar-hide",children:t.jsx("div",{className:"prose prose-lg prose-invert prose-p:text-indigo-100 prose-p:leading-loose prose-p:font-light font-serif",children:t.jsx("p",{className:"whitespace-pre-wrap",children:i.letter})})}),t.jsx("div",{className:"pt-6 mt-6 border-t border-white/5 shrink-0",children:t.jsx(A,{variant:"ghost",onClick:i.reset,className:"w-full text-indigo-300 hover:text-white hover:bg-white/5 py-4 text-base","aria-label":"새 기록 시작하기",children:"새 기록 시작하기"})})]})},"step-letter")]}),t.jsx(F,{children:l&&t.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"fixed top-24 left-1/2 -translate-x-1/2 z-popover flex items-center gap-3 px-6 py-3 bg-emerald-500/90 backdrop-blur-xl text-white rounded-full shadow-2xl border border-white/20",children:[t.jsx(he,{size:20}),t.jsx("span",{className:"font-bold text-sm",children:"저장되었습니다"})]})})]})},Kt=({isOpen:e,onConsent:n,onSkip:a})=>{const r=pe(),[l,s]=o.useState(!1),[u,c]=o.useState(!1),i=o.useRef(null);Re({enabled:e,containerRef:i,initialFocusSelector:'input[type="checkbox"]'}),Me({shouldRestore:!e});const f=async()=>{if(l)try{c(!0),await se(!0),n()}catch(h){console.error("Failed to save consent:",h),alert("동의 저장 중 오류가 발생했습니다. 다시 시도해주세요.")}finally{c(!1)}},S=async()=>{try{await se(!1),a()}catch(h){console.error("Failed to save consent skip:",h),a()}};return t.jsx(De,{children:t.jsx(F,{children:e&&t.jsxs(t.Fragment,{children:[t.jsx(x.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-consent-backdrop bg-black/50 backdrop-blur-sm",onClick:S}),t.jsx(x.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"fixed inset-0 z-consent-modal flex items-center justify-center p-4 pointer-events-none",children:t.jsxs("div",{ref:i,className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6 pointer-events-auto",onClick:h=>h.stopPropagation(),children:[t.jsx("div",{className:"flex items-center justify-between mb-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-brand-primary/10 flex items-center justify-center",children:t.jsx(ne,{size:24,className:"text-brand-primary"})}),t.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"대화 저장에 동의하시겠습니까?"})]})}),t.jsxs("div",{className:"space-y-4 mb-6",children:[t.jsx("p",{className:"text-sm text-slate-600 leading-relaxed",children:"대화와 일기 원문을 저장하면 더 나은 경험을 제공할 수 있습니다."}),t.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 space-y-3",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"📋 저장 목적"}),t.jsx("p",{className:"text-xs text-slate-600",children:"체크인/리포트/액션 추천, AI 인사이트 생성"})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"⏰ 보관기간"}),t.jsx("p",{className:"text-xs text-slate-600",children:"영구 (삭제 요청 시까지)"})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-sm text-slate-800 mb-1",children:"🗑️ 삭제 권한"}),t.jsx("p",{className:"text-xs text-slate-600",children:"언제든 개별 메시지/대화/전체 삭제 가능"})]})]}),t.jsxs("div",{className:"flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200",children:[t.jsx("div",{className:"pt-0.5",children:t.jsx(ne,{size:16,className:"text-amber-600"})}),t.jsx("p",{className:"text-xs text-amber-800 leading-relaxed",children:"동의 없이도 기본 기능은 사용 가능하나, 대화 저장 기능은 사용할 수 없습니다. 감정 수치와 태그는 동의 없이도 저장됩니다."})]}),t.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[t.jsxs("div",{className:"relative mt-0.5",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:h=>s(h.target.checked),className:"sr-only"}),t.jsx("div",{className:`
                        w-5 h-5 rounded border-2 flex items-center justify-center transition-all
                        ${l?"bg-brand-primary border-brand-primary":"border-slate-300 group-hover:border-brand-primary/50"}
                      `,children:l&&t.jsx(Ze,{size:14,className:"text-white",strokeWidth:3})})]}),t.jsx("span",{className:"text-sm text-slate-700 leading-relaxed",children:"위 내용을 확인했으며, 대화 저장에 동의합니다."})]})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(A,{onClick:f,variant:"primary",className:"flex-1",disabled:!l||u,children:u?"저장 중...":"동의하고 시작하기"}),t.jsx(A,{onClick:S,variant:"ghost",className:"px-6",children:"나중에"})]}),t.jsx("div",{className:"mt-4 text-center",children:t.jsx("button",{onClick:()=>{r("/profile/privacy/policy")},className:"text-xs text-slate-500 hover:text-brand-primary transition-colors underline","aria-label":"개인정보 처리방침 자세히 보기",children:"자세히 보기"})})]})})]})})})},ii=()=>{const e=pe(),{mode:n,persona:a,addTimelineEntry:r}=Oe(),{setIsImmersive:l}=ze(),[s,u]=o.useState(!1),[c,i]=o.useState(!1);o.useEffect(()=>{(async()=>{if(!c)try{const d=await Le();!d.consentedAt&&!d.revokedAt&&u(!0),i(!0)}catch(d){console.error("Error checking consent:",d),i(!0)}})()},[c]);const f=async j=>{try{await ye({emotion:j.emotion,intensity:j.intensity,contextTags:j.nuanceTags,modeAtTime:n}),r(j)}catch(d){$e("ChatMain.handleSaveEntry",d)}},S=()=>{e("/reports/weekly")},h=()=>{e("/safety?returnTo="+encodeURIComponent("/chat"))},T=()=>{e("/safety?returnTo="+encodeURIComponent("/chat"))},g=()=>{u(!1)},b=()=>{u(!1)};return t.jsxs(t.Fragment,{children:[t.jsx(Kt,{isOpen:s,onConsent:g,onSkip:b}),n==="day"?t.jsx(Ot,{persona:a,onSave:f,setImmersive:l,onNavigateToReports:S,onOpenSafety:h,onCrisisDetected:T}):t.jsx(Wt,{persona:a,onSave:f,onCrisisDetected:T})]})};export{ii as ChatMain};
